<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水位観測アプリ</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #map { height: 100vh; }
        .modal-hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    
    <!-- メインコンテンツ -->
    <div id="main-content">
        <div id="map"></div>
        <div id="project-indicator" class="hidden fixed top-4 left-1/2 -translate-x-1/2 bg-white/90 p-2 rounded-lg shadow-lg z-[1001] flex items-center space-x-4">
            <span class="font-semibold">プロジェクト: <span id="current-project-id-display"></span></span>
            <button id="switch-project-btn" class="text-sm text-blue-600 hover:underline">切り替え</button>
        </div>
        <div class="fixed bottom-4 right-4 z-[1001] flex flex-col space-y-2">
            <button id="open-add-well-modal-btn" class="bg-green-600 text-white p-4 rounded-full shadow-lg hover:bg-green-700" title="新規井戸追加"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg></button>
        </div>
    </div>
    
    <!-- プロジェクト選択モーダル -->
    <div id="project-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-[2000]">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">プロジェクト選択</h2>
            <div class="mb-4">
                <label for="project-id-input" class="block text-sm font-medium text-gray-700">プロジェクトID</label>
                <input type="text" id="project-id-input" placeholder="例: tokyo-site-2025" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
            <button id="start-project-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md font-bold hover:bg-blue-700">開始</button>
            <div class="mt-6">
                <h3 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-3">最近使ったプロジェクト</h3>
                <div id="recent-projects-list" class="space-y-2 max-h-32 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <!-- 新規井戸追加モーダル -->
    <div id="add-well-modal" class="modal-hidden fixed inset-0 bg-gray-600 bg-opacity-50 z-[1003] flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg w-full max-w-lg shadow-lg">
            <h3 class="text-lg font-medium text-gray-900 mb-4">新規井戸の追加</h3>
            <form id="add-well-form" class="space-y-4">
                 <div><label for="new-well-id" class="block text-sm">井戸ID (必須)</label><input type="text" id="new-well-id" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
                <div><label for="new-well-name" class="block text-sm">井戸名 (必須)</label><input type="text" id="new-well-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label for="new-well-lat" class="block text-sm">緯度 (必須)</label><input type="number" id="new-well-lat" step="any" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
                    <div><label for="new-well-lng" class="block text-sm">経度 (必須)</label><input type="number" id="new-well-lng" step="any" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
                </div>
            </form>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="close-add-well-modal-btn" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">キャンセル</button>
                <button id="save-new-well-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">保存</button>
            </div>
        </div>
    </div>
    
    <div id="debug-panel" class="fixed bottom-0 left-0 bg-black bg-opacity-70 text-white text-xs p-2 z-[9999] font-mono"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDocs, onSnapshot, collection, writeBatch, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const App = {
            status: 'initializing',
            db: null, auth: null, userId: null, currentProjectId: null,
            unsubscribeWells: null, map: null, wellMarkersLayer: null,
            dom: {},

            setStatus(newStatus, error = null) {
                this.status = newStatus;
                this.updateDebugPanel(error);
            },
            updateDebugPanel(error = null) {
                if (!this.dom.debugPanel) return;
                this.dom.debugPanel.innerHTML = `<strong>Status:</strong> ${this.status}<br><strong>UserID:</strong> ${this.userId ? 'OK' : 'Pending'}<br><strong>ProjectID:</strong> ${this.currentProjectId || 'None'}${error ? `<br><strong>Error:</strong> <span style="color: red;">${error.message}</span>` : ''}`;
            },
            
            async start() {
                this.setStatus('initializing');
                this.bindDOMElements();
                await this.initializeFirebase();
            },
            async initializeFirebase() {
                try {
                    this.setStatus('authenticating');
                    const firebaseConfig = { apiKey: "AIzaSyAYovasyBOIls5q9ZVX7_HeJmeeDD9OcpU", authDomain: "idochousa2025.firebaseapp.com", projectId: "idochousa2025", storageBucket: "idochousa2025.appspot.com", messagingSenderId: "55272688318", appId: "1:55272688318:web:c665ace11cda1a9eeb2cef" };
                    const app = initializeApp(firebaseConfig);
                    this.db = getFirestore(app);
                    this.auth = getAuth(app);
                    
                    await signInAnonymously(this.auth);
                    this.userId = await this.waitForAuth();
                    
                    this.setStatus('authenticated');
                    this.initializeAppLogic();
                } catch (error) {
                    this.setStatus('error', error);
                }
            },
            waitForAuth() {
                return new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => reject(new Error("Authentication timed out")), 10000);
                    const unsubscribe = onAuthStateChanged(this.auth, user => {
                        if (user) {
                            clearTimeout(timeout);
                            unsubscribe();
                            resolve(user.uid);
                        }
                    }, error => {
                        clearTimeout(timeout);
                        unsubscribe();
                        reject(error);
                    });
                });
            },
            initializeAppLogic() {
                this.setStatus('project_selection');
                this.setupEventListeners();
                this.initMap();
                const recentProjects = JSON.parse(localStorage.getItem('recentProjects') || '[]');
                this.updateRecentProjectsList(recentProjects);
                this.showProjectModal();
            },
            
            async startProject(id) {
                if (!id) { return alert('プロジェクトIDが無効です。'); }
                
                this.resetAppState();
                this.currentProjectId = id;
                this.saveProjectHistory(id);
                this.setStatus('loading_project');

                try {
                    await Promise.race([
                        this.loadProjectData(),
                        new Promise((_, reject) => setTimeout(() => reject(new Error("Database load timed out.")), 15000))
                    ]);
                    
                    this.dom.currentProjectIdDisplay.textContent = this.currentProjectId;
                    this.dom.projectIndicator.classList.remove('hidden');
                    this.hideProjectModal();
                    this.setStatus('running');
                } catch (error) {
                    this.setStatus('error', error);
                    alert(`プロジェクト読み込みエラー: ${error.message}`);
                    this.currentProjectId = null;
                    this.showProjectModal();
                }
            },

            bindDOMElements() {
                this.dom = {
                    projectModal: document.getElementById('project-modal'), startProjectBtn: document.getElementById('start-project-btn'),
                    switchProjectBtn: document.getElementById('switch-project-btn'), projectIndicator: document.getElementById('project-indicator'),
                    currentProjectIdDisplay: document.getElementById('current-project-id-display'), recentProjectsList: document.getElementById('recent-projects-list'),
                    projectIdInput: document.getElementById('project-id-input'), addWellModal: document.getElementById('add-well-modal'),
                    openAddWellBtn: document.getElementById('open-add-well-modal-btn'), closeAddWellBtn: document.getElementById('close-add-well-modal-btn'),
                    saveWellBtn: document.getElementById('save-new-well-btn'), addWellForm: document.getElementById('add-well-form'),
                    debugPanel: document.getElementById('debug-panel'),
                };
            },
            setupEventListeners() {
                this.dom.startProjectBtn.addEventListener('click', () => {
                    const id = this.dom.projectIdInput.value.trim().replace(/[^a-zA-Z0-9-]/g, '');
                    this.startProject(id);
                });
                this.dom.switchProjectBtn.addEventListener('click', () => this.showProjectModal());
                this.dom.openAddWellBtn.addEventListener('click', () => this.showAddWellModal());
                this.dom.closeAddWellBtn.addEventListener('click', () => this.hideAddWellModal());
                this.dom.saveWellBtn.addEventListener('click', () => this.handleSaveNewWell());
            },
            resetAppState() {
                if (this.unsubscribeWells) this.unsubscribeWells();
                if (this.wellMarkersLayer) this.wellMarkersLayer.clearLayers();
                this.dom.projectIndicator.classList.add('hidden');
            },
            saveProjectHistory(id) {
                let recent = JSON.parse(localStorage.getItem('recentProjects') || '[]').filter(p => p !== id);
                recent.unshift(id);
                localStorage.setItem('recentProjects', JSON.stringify(recent.slice(0, 5)));
                localStorage.setItem('currentProjectId', id);
                this.updateRecentProjectsList(recent);
            },
            async loadProjectData() {
                if (!this.currentProjectId) throw new Error("Project ID is not set.");
                await this.populateSampleData();
                this.listenForWells();
            },
            
            // ★★★★★ 解決策の核心 ★★★★★
            // UIの表示/非表示を直接的なスタイル操作で行う
            showProjectModal() {
                this.setStatus('project_selection');
                this.dom.projectModal.style.display = 'flex';
            },
            hideProjectModal() {
                this.dom.projectModal.style.display = 'none';
            },

            updateRecentProjectsList(projects) {
                this.dom.recentProjectsList.innerHTML = projects.length ? '' : '<p class="text-gray-500 text-sm">履歴はありません。</p>';
                projects.forEach(id => {
                    const item = document.createElement('button');
                    item.className = 'w-full text-left p-2 bg-gray-100 hover:bg-gray-200 rounded-md';
                    item.textContent = id;
                    item.onclick = () => this.startProject(id);
                    this.dom.recentProjectsList.appendChild(item);
                });
            },
            getCollections() {
                if (!this.currentProjectId) throw new Error("Cannot get collections, Project ID is empty.");
                return { wells: collection(this.db, 'projects', this.currentProjectId, 'wells') };
            },
            async populateSampleData() {
                const { wells } = this.getCollections();
                const snapshot = await getDocs(wells);
                if (snapshot.empty) {
                    const batch = writeBatch(this.db);
                    const sample = { id: 'well-001', name: 'サンプル井戸', lat: 35.681, lng: 139.767 };
                    const { id, ...data } = sample;
                    batch.set(doc(wells, id), data);
                    await batch.commit();
                }
            },
            listenForWells() {
                if (this.unsubscribeWells) this.unsubscribeWells();
                this.unsubscribeWells = onSnapshot(this.getCollections().wells, (snapshot) => {
                    const wellList = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    this.updateMapMarkers(wellList);
                });
            },
            initMap() {
                if (this.map) return;
                this.map = L.map('map').setView([35.681, 139.767], 10);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' }).addTo(this.map);
                this.wellMarkersLayer = L.featureGroup().addTo(this.map);
            },
            updateMapMarkers(wells) {
                if (!this.wellMarkersLayer) return;
                this.wellMarkersLayer.clearLayers();
                wells.forEach(well => {
                    if (well.lat != null && well.lng != null) {
                        L.marker([well.lat, well.lng]).bindPopup(`<b>${well.name}</b>`).addTo(this.wellMarkersLayer);
                    }
                });
                if (wells.length > 0) this.map.fitBounds(this.wellMarkersLayer.getBounds(), { padding: [50, 50] });
            },
            showAddWellModal() {
                this.dom.addWellForm.reset();
                document.getElementById('new-well-id').value = `well-${Date.now()}`;
                this.dom.addWellModal.classList.remove('modal-hidden');
            },
            hideAddWellModal() {
                this.dom.addWellModal.classList.add('modal-hidden');
            },
            async handleSaveNewWell() {
                const id = document.getElementById('new-well-id').value.trim();
                const name = document.getElementById('new-well-name').value.trim();
                const lat = parseFloat(document.getElementById('new-well-lat').value);
                const lng = parseFloat(document.getElementById('new-well-lng').value);
                if (!id || !name || isNaN(lat) || isNaN(lng)) return alert('必須項目を全て入力してください。');
                try {
                    await setDoc(doc(this.getCollections().wells, id), { name, lat, lng });
                    this.hideAddWellModal();
                    alert('新規井戸を保存しました。');
                } catch (error) {
                    alert(`保存に失敗しました: ${error.message}`);
                }
            },
        };

        document.addEventListener('DOMContentLoaded', () => App.start());
    </script>
</body>
</html>
