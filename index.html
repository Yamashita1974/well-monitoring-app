<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水位観測アプリ</title>
    
    <!-- PWAマニフェスト -->
    <link rel="manifest" href="manifest.json">

    <!-- スタイルシート (Tailwind CSS & Leaflet CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    
    <!-- ライブラリ (Leaflet & Chart.js) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* UIの微調整 */
        #map { height: 100vh; cursor: default; }
        .map-crosshair { cursor: crosshair; }
        .leaflet-bottom, .leaflet-top { z-index: 1000; }
        .slide-in {
            transform: translateX(0%);
            transition: transform 0.3s ease-in-out;
        }
        .slide-out {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        /* モーダル表示用のスタイル */
        .modal-hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    
    <!-- 地図コンテナ -->
    <div id="map"></div>

    <!-- UIボタンコンテナ -->
    <div class="fixed bottom-4 right-4 z-[1001] flex flex-col space-y-2">
        <button id="open-import-modal-btn" class="bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" title="データ取込">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
        </button>
        <button id="open-add-well-modal-btn" class="bg-green-600 text-white p-4 rounded-full shadow-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" title="新規井戸追加">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
        </button>
        <button id="open-well-list-modal-btn" class="bg-gray-600 text-white p-4 rounded-full shadow-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2" title="井戸一覧">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
            </svg>
        </button>
    </div>
    
    <!-- データ取込モーダル -->
    <div id="import-modal" class="modal-hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[1002]">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">既存データのインポート</h3>
                <div class="mt-2 px-7 py-3 text-left">
                    <p class="text-sm text-gray-500 mb-2">
                        既存の井戸データをCSVファイルでアップロードします。
                        <br><strong>注意：</strong>インポートすると既存のデータは全て上書きされます。
                    </p>
                    <p class="text-sm font-semibold text-gray-700">CSVフォーマット:</p>
                    <pre class="bg-gray-100 p-2 rounded-md text-xs overflow-x-auto">well_id,well_name,lat,lng,address,elevation
well-001,A-1観測井,35.681,139.767,東京都千代田区,25.5
well-002,B-3調査井,35.443,139.638,神奈川県横浜市,15.2</pre>
                    <p class="text-xs text-gray-500 mt-1">
                        ※ `well_id`, `well_name`, `lat`, `lng` は必須です。
                    </p>
                </div>
                <div id="import-status" class="mt-2 text-sm"></div>
                <div class="items-center px-4 py-3">
                    <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                    <button id="select-file-btn" class="w-full px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        CSVファイルを選択
                    </button>
                    <button id="close-import-modal-btn" class="w-full px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 mt-2">
                        閉じる
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新規井戸追加モーダル -->
    <div id="add-well-modal" class="modal-hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[1003]">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">新規井戸の追加</h3>
                <form id="add-well-form">
                    <div class="space-y-4">
                        <div>
                            <label for="new-well-id" class="block text-sm font-medium text-gray-700">井戸ID (必須)</label>
                            <input type="text" id="new-well-id" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="new-well-name" class="block text-sm font-medium text-gray-700">井戸名 (必須)</label>
                            <input type="text" id="new-well-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="new-well-kouji-bango" class="block text-sm font-medium text-gray-700">工事番号</label>
                            <input type="text" id="new-well-kouji-bango" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="w-1/2">
                                <label for="new-well-lat" class="block text-sm font-medium text-gray-700">緯度 (必須)</label>
                                <input type="number" id="new-well-lat" step="any" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                            <div class="w-1/2">
                                <label for="new-well-lng" class="block text-sm font-medium text-gray-700">経度 (必須)</label>
                                <input type="number" id="new-well-lng" step="any" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                        </div>
                        <button id="select-location-btn" type="button" class="w-full text-sm text-blue-600 hover:underline">または地図上で位置を選択</button>
                        <div>
                            <label for="new-well-address" class="block text-sm font-medium text-gray-700">所在地</label>
                            <input type="text" id="new-well-address" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="new-well-elevation" class="block text-sm font-medium text-gray-700">標高 (m)</label>
                            <input type="number" step="0.1" id="new-well-elevation" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>
                </form>
                <div id="add-well-error" class="mt-2 text-sm text-red-600"></div>
                <div class="items-center px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse mt-4">
                    <button id="save-new-well-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
                        保存
                    </button>
                    <button id="close-add-well-modal-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                        キャンセル
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 井戸一覧モーダル -->
    <div id="well-list-modal" class="modal-hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[1003]">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900">井戸一覧</h3>
                <button id="close-well-list-modal-btn" class="text-gray-500 hover:text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="mb-4 flex items-center space-x-2">
                <span class="text-sm font-medium text-gray-700">並び順:</span>
                <button id="sort-by-name-btn" class="px-3 py-1 text-sm font-semibold text-white bg-blue-600 rounded-md shadow-sm">井戸名順</button>
                <button id="sort-by-kouji-btn" class="px-3 py-1 text-sm font-semibold text-gray-700 bg-gray-200 rounded-md shadow-sm">工事番号順</button>
            </div>
            <div class="max-h-[70vh] overflow-y-auto">
                <ul id="well-list-container" class="space-y-2">
                    <!-- 井戸リストはここに動的に挿入されます -->
                </ul>
            </div>
        </div>
    </div>

    <!-- 削除確認モーダル -->
    <div id="delete-confirm-modal" class="modal-hidden fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-[1004]">
        <div class="relative top-40 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
             <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">井戸を削除しますか？</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        この操作は元に戻せません。この井戸に関連する全ての測定データも永久に削除されます。
                    </p>
                </div>
                <div class="items-center px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button id="confirm-delete-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                        削除
                    </button>
                    <button id="cancel-delete-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                        キャンセル
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- 井戸詳細サイドパネル -->
    <div id="well-details-panel" class="fixed top-0 right-0 h-full w-full md:w-1/3 bg-white shadow-lg z-[1001] p-6 overflow-y-auto slide-out">
        <div class="flex justify-between items-center mb-4">
            <h2 id="well-name" class="text-2xl font-bold text-gray-800"></h2>
            <button id="close-panel-btn" class="text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        
        <div class="mb-6 bg-gray-50 p-4 rounded-lg">
            <div class="flex justify-between items-start">
                 <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">井戸情報</h3>
                    <p class="text-sm text-gray-600"><strong>ID:</strong> <span id="well-id-details"></span></p>
                    <p class="text-sm text-gray-600"><strong>工事番号:</strong> <span id="well-kouji-bango-details"></span></p>
                    <p class="text-sm text-gray-600"><strong>所在地:</strong> <span id="well-address"></span></p>
                    <p class="text-sm text-gray-600"><strong>標高:</strong> <span id="well-elevation"></span> m</p>
                </div>
                <div class="text-right">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">ユーザー</h3>
                    <p id="user-id-display" class="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded-full"></p>
                </div>
            </div>
        </div>

        <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-2">新規測定</h3>
            <div class="flex items-center space-x-2">
                <input type="number" id="water-level-input" step="0.01" placeholder="地表からの水位 (m)" class="flex-grow p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                <button id="add-measurement-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold shadow">保存</button>
            </div>
        </div>

        <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-2">水位トレンド</h3>
            <canvas id="water-level-chart"></canvas>
        </div>

        <div>
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-semibold text-gray-700">測定履歴</h3>
                <button id="export-csv-btn" class="flex items-center space-x-2 bg-gray-200 text-gray-700 px-3 py-1 rounded-md hover:bg-gray-300 text-sm font-semibold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    <span>CSVエクスポート</span>
                </button>
            </div>
            <ul id="measurement-list" class="space-y-2"></ul>
        </div>
        
        <div class="mt-8 pt-6 border-t border-gray-200">
             <button id="delete-well-btn" class="w-full flex justify-center items-center space-x-2 bg-red-100 text-red-700 px-4 py-2 rounded-md hover:bg-red-200 font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                <span>この井戸を削除</span>
            </button>
        </div>

    </div>
    
    <div id="offline-indicator" class="hidden fixed bottom-4 left-4 bg-yellow-500 text-white text-sm font-bold py-2 px-4 rounded-full shadow-lg z-[1002]">
        <p>オフラインモードで動作中</p>
    </div>
    
    <div id="sync-indicator" class="hidden fixed bottom-4 right-4 bg-green-500 text-white text-sm font-bold py-2 px-4 rounded-full shadow-lg z-[1002]">
        <p>データを同期しました</p>
    </div>


    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, writeBatch, enableNetwork, disableNetwork, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================================
        // グローバル変数と初期設定
        // =================================================================================
        let db, auth;
        let userId = null;
        let unsubscribeWells = null;
        let unsubscribeMeasurements = null;

        let map;
        let waterLevelChart;
        let currentWell = null;
        let wellMarkersLayer = L.featureGroup();
        let wellMarkers = {};
        let allWellsCache = [];
        
        // =================================================================================
        // Firebase 初期化と認証
        // =================================================================================
        async function initializeFirebase() {
            try {
                const firebaseConfig = {
                  apiKey: "AIzaSyAYovasyBOIls5q9ZVX7_HeJmeeDD9OcpU",
                  authDomain: "idochousa2025.firebaseapp.com",
                  projectId: "idochousa2025",
                  storageBucket: "idochousa2025.appspot.com",
                  messagingSenderId: "55272688318",
                  appId: "1:55272688318:web:c665ace11cda1a9eeb2cef"
                };

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated User ID:", userId);
                        document.getElementById('user-id-display').textContent = `${userId.substring(0, 8)}...`;
                        
                        initMap();
                        await populateSampleData();
                        listenForWells();
                    } else {
                        console.log("No user signed in.");
                    }
                });

                await signInAnonymously(auth);

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                 if (error.code === 'auth/configuration-not-found') {
                    alert("Firebase認証エラー: 匿名認証が有効になっていません。\n\nFirebaseコンソールの「Authentication」>「Sign-in method」タブで、「匿名」プロバイダを有効にしてください。");
                } else {
                    alert("アプリケーションの初期化に失敗しました。設定を確認してください。");
                }
            }
        }
        
        // =================================================================================
        // アプリケーションの初期設定とPWAサービスワーカーの登録
        // =================================================================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => console.log('ServiceWorker登録成功:', registration.scope))
                    .catch(error => console.log('ServiceWorker登録失敗:', error));
            });
        }
        
        window.addEventListener('online', () => {
            document.getElementById('offline-indicator').classList.add('hidden');
            if(db) enableNetwork(db).then(() => console.log("Network enabled."));
        });
        window.addEventListener('offline', () => {
            document.getElementById('offline-indicator').classList.remove('hidden');
            if(db) disableNetwork(db).then(() => console.log("Network disabled."));
        });
        if (!navigator.onLine) {
            document.getElementById('offline-indicator').classList.remove('hidden');
        }

        // =================================================================================
        // Firestore データ操作
        // =================================================================================
        
        function getCollections() {
            // ★★★★★ 修正点: データ保存経路を簡素化 ★★★★★
            const wellsCollectionRef = collection(db, 'wells');
            const measurementsCollectionRef = collection(db, 'measurements');
            return { wellsCollectionRef, measurementsCollectionRef };
        }

        async function populateSampleData() {
            const { wellsCollectionRef } = getCollections();
            const snapshot = await getDocs(wellsCollectionRef);

            if (snapshot.empty) {
                console.log('Firestoreが空のため、サンプルデータを投入します');
                const wells = [
                    { id: 'well-001', name: 'A-1観測井', kouji_bango: '2025-A-01', address: '東京都千代田区', elevation: 25.5, lat: 35.681236, lng: 139.767125 },
                    { id: 'well-002', name: 'B-3調査井', kouji_bango: '2025-B-03', address: '神奈川県横浜市', elevation: 15.2, lat: 35.443707, lng: 139.638031 },
                    { id: 'well-003', name: 'C-5揚水井', kouji_bango: '2025-A-02', address: '埼玉県さいたま市', elevation: 8.9, lat: 35.861729, lng: 139.645485 }
                ];
                const measurements = [
                    { well_id: 'well-001', timestamp: new Date('2025-03-15T10:00:00Z'), water_level: 15.23, operator_id: 'sample_user' },
                ];

                const { measurementsCollectionRef } = getCollections();
                const batch = writeBatch(db);
                wells.forEach(well => {
                    const docRef = doc(wellsCollectionRef, well.id);
                    batch.set(docRef, well);
                });
                measurements.forEach(m => {
                    const docRef = doc(collection(measurementsCollectionRef)); 
                    batch.set(docRef, m);
                });
                await batch.commit();
                console.log("サンプルデータを投入しました。");
            } else {
                console.log('既存のデータがあるため、サンプル投入をスキップします');
            }
        }
        
        function listenForWells() {
            if (unsubscribeWells) unsubscribeWells(); 
            
            const { wellsCollectionRef } = getCollections();
            unsubscribeWells = onSnapshot(wellsCollectionRef, (snapshot) => {
                const wells = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allWellsCache = wells; // Update cache for sorting
                updateMapMarkers(wells);
            }, (error) => {
                console.error("Error listening for well updates:", error);
            });
        }
        
        function updateMapMarkers(wells) {
            wellMarkersLayer.clearLayers(); 
            wellMarkers = {};
            
            if(wells.length === 0) return;

            wells.forEach(well => {
                if (well.lat == null || well.lng == null) return;
                const marker = L.marker([well.lat, well.lng]);
                marker.bindPopup(`<b>${well.name}</b>`).on('click', () => {
                    openWellDetailsPanel(well);
                });
                wellMarkersLayer.addLayer(marker);
                wellMarkers[well.id] = marker; 
            });

            if (Object.keys(wellMarkers).length > 0) {
                 map.fitBounds(wellMarkersLayer.getBounds(), { padding: [50, 50] });
            }
        }


        // =================================================================================
        // 地図の初期化
        // =================================================================================
        
        function initMap() {
            if (map) return;
            map = L.map('map').setView([35.681236, 139.767125], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            wellMarkersLayer.addTo(map);
        }

        // =================================================================================
        // UI操作（サイドパネル、チャート、リスト）
        // =================================================================================

        function openWellDetailsPanel(well) {
            if (unsubscribeMeasurements) unsubscribeMeasurements();

            currentWell = well;
            const panel = document.getElementById('well-details-panel');
            document.getElementById('well-name').textContent = well.name;
            document.getElementById('well-id-details').textContent = well.id;
            document.getElementById('well-kouji-bango-details').textContent = well.kouji_bango || 'N/A';
            document.getElementById('well-address').textContent = well.address || 'N/A';
            document.getElementById('well-elevation').textContent = well.elevation || 'N/A';
            
            panel.classList.remove('slide-out');
            panel.classList.add('slide-in');
            
            const { measurementsCollectionRef } = getCollections();
            const q = query(measurementsCollectionRef, where("well_id", "==", well.id));
            
            unsubscribeMeasurements = onSnapshot(q, (snapshot) => {
                const measurements = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                measurements.forEach(m => {
                    if (m.timestamp && m.timestamp.toDate) m.timestamp = m.timestamp.toDate();
                });
                measurements.sort((a,b) => b.timestamp - a.timestamp);
                
                updateMeasurementList(measurements);
                updateWaterLevelChart(measurements);
            });
        }
        
        function closePanel() {
            if (unsubscribeMeasurements) unsubscribeMeasurements();
            const panel = document.getElementById('well-details-panel');
            panel.classList.remove('slide-in');
            panel.classList.add('slide-out');
            currentWell = null;
        }

        function updateMeasurementList(measurements) {
            const listEl = document.getElementById('measurement-list');
            listEl.innerHTML = '';
            
            if (measurements.length === 0) {
                listEl.innerHTML = '<li class="text-gray-500">測定データがありません。</li>';
                return;
            }

            measurements.forEach(m => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-3 bg-white border rounded-md';
                const date = new Date(m.timestamp).toLocaleString('ja-JP');
                const operator = m.operator_id ? m.operator_id.substring(0,8) : 'N/A';

                li.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800">${m.water_level.toFixed(2)} m</p>
                        <p class="text-sm text-gray-500">${date}</p>
                    </div>
                    <div class="text-xs text-gray-400" title="測定者: ${m.operator_id}">
                        ${operator}
                    </div>
                `;
                listEl.appendChild(li);
            });
        }
        
        function updateWaterLevelChart(measurements) {
            const ctx = document.getElementById('water-level-chart').getContext('2d');
            const sortedMeasurements = [...measurements].sort((a,b) => a.timestamp - b.timestamp);
            const labels = sortedMeasurements.map(m => new Date(m.timestamp).toLocaleDateString('ja-JP'));
            const data = sortedMeasurements.map(m => m.water_level);

            if (waterLevelChart) {
                waterLevelChart.destroy();
            }
            waterLevelChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '水位 (m)',
                        data: data,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: { 
                    responsive: true, 
                    scales: { 
                        y: { 
                            title: { display: true, text: '地表からの水位 (m)' },
                            reverse: true
                        } 
                    }, 
                    plugins: { legend: { display: false } } 
                }
            });
        }
        
        // =================================================================================
        // イベントリスナーとデータ処理
        // =================================================================================
        async function handleAddMeasurement() {
            const inputEl = document.getElementById('water-level-input');
            const waterLevel = parseFloat(inputEl.value);

            if (!currentWell || isNaN(waterLevel)) {
                alert('有効な水位を入力してください。');
                return;
            }

            const measurement = {
                well_id: currentWell.id,
                timestamp: serverTimestamp(),
                water_level: waterLevel,
                operator_id: userId
            };

            const { measurementsCollectionRef } = getCollections();
            try {
                await addDoc(measurementsCollectionRef, measurement);
                console.log("測定データを保存しました。");
                inputEl.value = '';
            } catch (error) {
                console.error("測定データの保存に失敗:", error);
                alert("データの保存に失敗しました。");
            }
        }
        
        document.getElementById('close-panel-btn').addEventListener('click', closePanel);
        document.getElementById('add-measurement-btn').addEventListener('click', handleAddMeasurement);

        // =================================================================================
        // データインポート/エクスポート/追加/削除機能
        // =================================================================================
        const importModal = document.getElementById('import-modal');
        const openImportModalBtn = document.getElementById('open-import-modal-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const addWellModal = document.getElementById('add-well-modal');
        const openAddWellModalBtn = document.getElementById('open-add-well-modal-btn');
        const deleteWellBtn = document.getElementById('delete-well-btn');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const wellListModal = document.getElementById('well-list-modal');
        const openWellListModalBtn = document.getElementById('open-well-list-modal-btn');

        // --- インポート関連 ---
        openImportModalBtn.addEventListener('click', () => importModal.classList.remove('modal-hidden'));
        document.getElementById('close-import-modal-btn').addEventListener('click', () => importModal.classList.add('modal-hidden'));
        document.getElementById('select-file-btn').addEventListener('click', () => document.getElementById('csv-file-input').click());
        document.getElementById('csv-file-input').addEventListener('change', handleFileSelect);
        
        // --- エクスポート関連 ---
        exportCsvBtn.addEventListener('click', handleExportCSV);

        // --- 井戸追加関連 ---
        openAddWellModalBtn.addEventListener('click', () => {
            document.getElementById('new-well-id').value = `well-${Date.now()}`;
            addWellModal.classList.remove('modal-hidden');
        });
        document.getElementById('close-add-well-modal-btn').addEventListener('click', () => addWellModal.classList.add('modal-hidden'));
        document.getElementById('save-new-well-btn').addEventListener('click', handleSaveNewWell);
        document.getElementById('select-location-btn').addEventListener('click', handleSelectLocationOnMap);

        // --- 井戸削除関連 ---
        deleteWellBtn.addEventListener('click', () => deleteConfirmModal.classList.remove('modal-hidden'));
        document.getElementById('cancel-delete-btn').addEventListener('click', () => deleteConfirmModal.classList.add('modal-hidden'));
        document.getElementById('confirm-delete-btn').addEventListener('click', handleDeleteWell);

        // --- 井戸一覧関連 ---
        openWellListModalBtn.addEventListener('click', handleOpenWellList);
        document.getElementById('close-well-list-modal-btn').addEventListener('click', () => wellListModal.classList.add('modal-hidden'));
        document.getElementById('sort-by-name-btn').addEventListener('click', () => renderWellList('name'));
        document.getElementById('sort-by-kouji-btn').addEventListener('click', () => renderWellList('kouji_bango'));

        // --- 実装 ---
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                try {
                    const data = parseCSV(text);
                    importDataToDB(data);
                } catch (error) {
                    const importStatus = document.getElementById('import-status');
                    importStatus.textContent = `エラー: ${error.message}`;
                    importStatus.className = 'mt-2 text-sm text-red-600';
                }
            };
            reader.readAsText(file);
        }

        function parseCSV(text) {
            const lines = text.trim().split(/\r?\n/);
            if (lines.length < 2) throw new Error("CSVファイルにデータがありません。");
            
            const header = lines[0].split(',').map(h => h.trim());
            const requiredHeaders = ['well_id', 'well_name', 'lat', 'lng'];
            for(const req of requiredHeaders){
                if(!header.includes(req)) throw new Error(`必須ヘッダーが見つかりません: ${req}`);
            }

            return lines.slice(1).map(line => {
                const values = line.split(',');
                const obj = {};
                header.forEach((h, i) => {
                    obj[h] = values[i] ? values[i].trim() : '';
                });
                return obj;
            });
        }

        async function importDataToDB(data) {
            const importStatus = document.getElementById('import-status');
            importStatus.textContent = "インポート処理中...";
            importStatus.className = 'mt-2 text-sm text-gray-700';

            const { wellsCollectionRef } = getCollections();
            const batch = writeBatch(db);

            data.forEach(row => {
                 const lat = parseFloat(row.lat);
                const lng = parseFloat(row.lng);
                const elevation = row.elevation ? parseFloat(row.elevation) : null;
                
                if (isNaN(lat) || isNaN(lng)) {
                    console.warn(`無効な座標です。スキップします: ${row.well_id}`);
                    return;
                }

                const wellData = {
                    id: row.well_id,
                    name: row.well_name,
                    kouji_bango: row.kouji_bango || '',
                    lat: lat,
                    lng: lng,
                    address: row.address || '',
                    elevation: isNaN(elevation) ? null : elevation
                };
                const docRef = doc(wellsCollectionRef, wellData.id);
                batch.set(docRef, wellData);
            });

            try {
                await batch.commit();
                importStatus.textContent = `${data.length}件の井戸データをインポートしました。`;
                importStatus.className = 'mt-2 text-sm text-green-600';
            } catch (error) {
                 importStatus.textContent = `データベースエラー: ${error.message}`;
                importStatus.className = 'mt-2 text-sm text-red-600';
            } finally {
                document.getElementById('csv-file-input').value = '';
            }
        }

        async function handleExportCSV() {
            if (!currentWell) {
                alert('エクスポートする井戸が選択されていません。');
                return;
            }

            const { measurementsCollectionRef } = getCollections();
            const q = query(measurementsCollectionRef, where("well_id", "==", currentWell.id));
            const querySnapshot = await getDocs(q);
            
            const measurements = querySnapshot.docs.map(doc => {
                const data = doc.data();
                if (data.timestamp && data.timestamp.toDate) {
                    data.timestamp = data.timestamp.toDate();
                }
                return data;
            }).sort((a,b) => a.timestamp - b.timestamp);
            
            if (measurements.length === 0) {
                alert('エクスポートする測定データがありません。');
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM for Excel
            csvContent += "測定日時,地表からの水位(m),測定者ID\r\n";

            measurements.forEach(row => {
                const date = new Date(row.timestamp).toLocaleString('ja-JP');
                const level = row.water_level.toFixed(2);
                const operator = row.operator_id || '';
                csvContent += `"${date}",${level},"${operator}"\r\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${currentWell.name}_測定履歴.csv`);
            document.body.appendChild(link);
            
            link.click();
            document.body.removeChild(link);
        }
        
        function handleSelectLocationOnMap() {
            addWellModal.classList.add('modal-hidden');

            const instruction = document.createElement('div');
            instruction.className = 'fixed top-4 left-1/2 -translate-x-1/2 bg-white text-gray-800 p-3 rounded-lg shadow-lg z-[1005]';
            instruction.innerHTML = 'マーカーをドラッグして位置を調整し、<br>左下のボタンで確定してください。';
            document.body.appendChild(instruction);
            
            const tempMarker = L.marker(map.getCenter(), { draggable: true }).addTo(map);

            const ConfirmControl = L.Control.extend({
                onAdd: function(map) {
                    const button = L.DomUtil.create('button', 'bg-green-600 text-white font-bold py-2 px-4 rounded shadow-lg');
                    button.innerText = 'この位置で確定';
                    L.DomEvent.on(button, 'click', (e) => {
                        L.DomEvent.stop(e);
                        finalizeSelection();
                    });
                    return button;
                },
            });

            const confirmButton = new ConfirmControl({ position: 'bottomleft' });
            map.addControl(confirmButton);

            const finalizeSelection = () => {
                const pos = tempMarker.getLatLng();
                document.getElementById('new-well-lat').value = pos.lat.toFixed(6);
                document.getElementById('new-well-lng').value = pos.lng.toFixed(6);
                map.removeControl(confirmButton);
                map.removeLayer(tempMarker);
                if(document.body.contains(instruction)) document.body.removeChild(instruction);
                addWellModal.classList.remove('modal-hidden');
            }
        }
        
        async function handleSaveNewWell() {
            const id = document.getElementById('new-well-id').value.trim();
            const name = document.getElementById('new-well-name').value.trim();
            const kouji_bango = document.getElementById('new-well-kouji-bango').value.trim();
            const lat = parseFloat(document.getElementById('new-well-lat').value);
            const lng = parseFloat(document.getElementById('new-well-lng').value);
            const address = document.getElementById('new-well-address').value.trim();
            const elevation = document.getElementById('new-well-elevation').value.trim();
            const errorDiv = document.getElementById('add-well-error');
            
            errorDiv.textContent = '';
            if (!id || !name || isNaN(lat) || isNaN(lng)) {
                errorDiv.textContent = '必須項目（ID, 名前, 緯度, 経度）をすべて入力してください。';
                return;
            }

            const newWell = {
                name, kouji_bango, lat, lng, address,
                elevation: elevation ? parseFloat(elevation) : null
            };
            
            const { wellsCollectionRef } = getCollections();
            const docRef = doc(wellsCollectionRef, id);

            try {
                await setDoc(docRef, newWell);
                console.log('新規井戸を保存しました:', newWell);
                addWellModal.classList.add('modal-hidden');
                document.getElementById('add-well-form').reset();
            } catch(e) {
                errorDiv.textContent = `データベースエラー: ${e.message}`;
            }
        }

        async function handleDeleteWell() {
            if (!currentWell) return;

            const wellIdToDelete = currentWell.id;
            const { wellsCollectionRef, measurementsCollectionRef } = getCollections();

            const batch = writeBatch(db);

            const wellDocRef = doc(wellsCollectionRef, wellIdToDelete);
            batch.delete(wellDocRef);

            const q = query(measurementsCollectionRef, where("well_id", "==", wellIdToDelete));
            const snapshot = await getDocs(q);
            snapshot.forEach(doc => {
                batch.delete(doc.ref);
            });
            
            try {
                await batch.commit();
                console.log(`井戸 ${wellIdToDelete} と関連データを削除しました。`);
                deleteConfirmModal.classList.add('modal-hidden');
                closePanel();
            } catch (e) {
                console.error('削除処理中にエラーが発生しました:', e);
                alert('削除中にエラーが発生しました。');
            }
        }

        function handleOpenWellList() {
            renderWellList('name'); // デフォルトは井戸名順
            wellListModal.classList.remove('modal-hidden');
        }

        function renderWellList(sortBy) {
            const listContainer = document.getElementById('well-list-container');
            const sortByNameBtn = document.getElementById('sort-by-name-btn');
            const sortByKoujiBtn = document.getElementById('sort-by-kouji-btn');
            listContainer.innerHTML = '';
            
            let sortedWells = [...allWellsCache];

            if (sortBy === 'name') {
                sortedWells.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ja'));
                sortByNameBtn.classList.replace('bg-gray-200', 'bg-blue-600');
                sortByNameBtn.classList.replace('text-gray-700', 'text-white');
                sortByKoujiBtn.classList.replace('bg-blue-600', 'bg-gray-200');
                sortByKoujiBtn.classList.replace('text-white', 'text-gray-700');
            } else if (sortBy === 'kouji_bango') {
                sortedWells.sort((a, b) => {
                    const koujiA = a.kouji_bango || '';
                    const koujiB = b.kouji_bango || '';
                    if (koujiA === '' && koujiB !== '') return 1;
                    if (koujiA !== '' && koujiB === '') return -1;
                    return koujiA.localeCompare(koujiB, undefined, { numeric: true });
                });
                sortByKoujiBtn.classList.replace('bg-gray-200', 'bg-blue-600');
                sortByKoujiBtn.classList.replace('text-gray-700', 'text-white');
                sortByNameBtn.classList.replace('bg-blue-600', 'bg-gray-200');
                sortByNameBtn.classList.replace('text-white', 'text-gray-700');
            }

            if (sortedWells.length === 0) {
                listContainer.innerHTML = '<li class="text-gray-500 text-center">登録されている井戸はありません。</li>';
            } else {
                sortedWells.forEach(well => {
                    const li = document.createElement('li');
                    li.className = 'p-3 hover:bg-gray-100 rounded-md cursor-pointer border-b';
                    const koujiDisplay = well.kouji_bango ? `<p class="text-xs text-green-700 font-semibold">工事番号: ${well.kouji_bango}</p>` : '';
                    li.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-gray-800">${well.name}</p>
                                <p class="text-sm text-gray-500">${well.id}</p>
                            </div>
                            ${koujiDisplay}
                        </div>
                    `;
                    li.addEventListener('click', () => jumpToWell(well));
                    listContainer.appendChild(li);
                });
            }
        }

        function jumpToWell(well) {
            wellListModal.classList.add('modal-hidden');

            if (well) {
                map.flyTo([well.lat, well.lng], 16);
                const marker = wellMarkers[well.id];
                if(marker) {
                    setTimeout(() => marker.openPopup(), 1000);
                }
            }
        }
        
        // =================================================================================
        // アプリケーションの起動
        // =================================================================================
        window.onload = async () => {
            await initializeFirebase();
        };

    </script>
    
    <!-- Service Worker and manifest files -->

</body>
</html>
