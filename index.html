<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水位観測アプリ</title>
    
    <!-- PWAマニフェスト -->
    <link rel="manifest" href="manifest.json">

    <!-- スタイルシート (Tailwind CSS & Leaflet CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    
    <!-- ライブラリ (Leaflet & Chart.js) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* UIの微調整 */
        #map { height: 100vh; cursor: default; }
        .map-crosshair { cursor: crosshair; }
        .leaflet-bottom, .leaflet-top { z-index: 1000; }
        .slide-in {
            transform: translateX(0%);
            transition: transform 0.3s ease-in-out;
        }
        .slide-out {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        /* モーダル表示用のスタイル */
        .modal-hidden {
            display: none;
        }
        /* 井戸ラベルのスタイル */
        .well-label {
            background-color: rgba(255, 255, 255, 0.85);
            border-color: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            padding: 4px 8px;
            font-weight: bold;
            font-size: 12px;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .graph-toggle-btn-active {
            background-color: #3b82f6; /* bg-blue-600 */
            color: white;
        }
        /* SVGアイコンの影を調整 */
        .leaflet-div-icon {
            background: none;
            border: none;
        }
        .leaflet-marker-icon svg {
             filter: drop-shadow( 0 2px 2px rgba(0,0,0,0.5) );
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    
    <!-- 地図コンテナ -->
    <div id="map"></div>

    <!-- UIボタンコンテナ -->
    <div class="fixed bottom-4 right-4 z-[1001] flex flex-col items-end space-y-2">
        <button id="toggle-labels-btn" class="bg-white text-gray-700 p-4 rounded-full shadow-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" title="ラベル表示切替">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
            </svg>
        </button>
        <button id="locate-me-btn" class="bg-white text-gray-700 p-4 rounded-full shadow-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" title="現在地へ移動">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
        </button>
        <button id="open-import-modal-btn" class="bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" title="データ取込">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
        </button>
        <button id="open-add-well-modal-btn" class="bg-green-600 text-white p-4 rounded-full shadow-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" title="新規井戸追加">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
        </button>
        <button id="open-well-list-modal-btn" class="bg-gray-600 text-white p-4 rounded-full shadow-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2" title="井戸一覧">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
            </svg>
        </button>
    </div>
    
    <!-- データ取込モーダル -->
    <div id="import-modal" class="modal-hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[1002]">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">既存データのインポート</h3>
                <div class="mt-2 px-7 py-3 text-left">
                    <p class="text-sm text-gray-500 mb-2">
                        既存の井戸データをCSVファイルでアップロードします。
                        <br><strong>注意：</strong>インポートすると既存のデータは全て上書きされます。
                    </p>
                    <p class="text-sm font-semibold text-gray-700">CSVフォーマット:</p>
                    <pre class="bg-gray-100 p-2 rounded-md text-xs overflow-x-auto">well_id,well_name,lat,lng,kouji_bango,reference_point_height,monitors_water_level,monitors_pumping_rate
well-001,A-1観測井,35.681,139.767,2025-A-01,0.5,true,false</pre>
                    <p class="text-xs text-gray-500 mt-1">
                        ※ `well_id`, `well_name`, `lat`, `lng` は必須です。
                    </p>
                </div>
                <div id="import-status" class="mt-2 text-sm"></div>
                <div class="items-center px-4 py-3">
                    <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                    <button id="select-file-btn" class="w-full px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-700">
                        CSVファイルを選択
                    </button>
                    <button id="close-import-modal-btn" class="w-full px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300 mt-2">
                        閉じる
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新規・編集井戸追加モーダル -->
    <div id="well-form-modal" class="modal-hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[1003]">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 id="well-form-title" class="text-lg leading-6 font-medium text-gray-900 mb-4"></h3>
                <form id="well-form">
                    <input type="hidden" id="well-form-mode" value="add">
                    <div class="space-y-4">
                        <div>
                            <label for="well-form-id" class="block text-sm font-medium text-gray-700">井戸ID (必須)</label>
                            <input type="text" id="well-form-id" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="well-form-name" class="block text-sm font-medium text-gray-700">井戸名 (必須)</label>
                            <input type="text" id="well-form-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div class="space-y-2">
                             <label class="block text-sm font-medium text-gray-700">観測種別 (複数選択可)</label>
                             <div class="flex items-center space-x-4">
                                <label class="flex items-center space-x-2"><input type="checkbox" id="well-form-monitors-water-level" class="h-4 w-4 rounded border-gray-300 text-blue-600"> <span>水位観測</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" id="well-form-monitors-pumping-rate" class="h-4 w-4 rounded border-gray-300 text-blue-600"> <span>揚水観測</span></label>
                             </div>
                        </div>
                        <div>
                            <label for="well-form-kouji-bango" class="block text-sm font-medium text-gray-700">工事番号</label>
                            <input type="text" id="well-form-kouji-bango" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                        </div>
                         <div>
                            <label for="well-form-reference-point-height" class="block text-sm font-medium text-gray-700">基準点高さ (m)</label>
                            <input type="number" step="0.01" id="well-form-reference-point-height" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="地表を0とした高さ。地表より上は+、下は-。">
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="w-1/2">
                                <label for="well-form-lat" class="block text-sm font-medium text-gray-700">緯度 (必須)</label>
                                <input type="number" id="well-form-lat" step="any" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div class="w-1/2">
                                <label for="well-form-lng" class="block text-sm font-medium text-gray-700">経度 (必須)</label>
                                <input type="number" id="well-form-lng" step="any" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                            </div>
                        </div>
                        <button id="select-location-btn" type="button" class="w-full text-sm text-blue-600 hover:underline">または地図上で位置を選択</button>
                        <div>
                            <label for="well-form-address" class="block text-sm font-medium text-gray-700">所在地</label>
                            <input type="text" id="well-form-address" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="well-form-elevation" class="block text-sm font-medium text-gray-700">地盤標高 (m)</label>
                            <input type="number" step="0.1" id="well-form-elevation" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                        </div>
                    </div>
                </form>
                <div id="well-form-error" class="mt-2 text-sm text-red-600"></div>
                <div class="items-center px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse mt-4">
                    <button id="save-well-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                        保存
                    </button>
                    <button id="close-well-form-modal-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">
                        キャンセル
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 井戸一覧モーダル -->
    <div id="well-list-modal" class="modal-hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[1003]">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900">井戸一覧</h3>
                <button id="close-well-list-modal-btn" class="text-gray-500 hover:text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="mb-4 flex justify-between items-center flex-wrap gap-2">
                 <div class="flex items-center space-x-2">
                    <span class="text-sm font-medium text-gray-700">並び順:</span>
                    <button id="sort-by-name-btn" class="px-3 py-1 text-sm font-semibold text-white bg-blue-600 rounded-md shadow-sm">井戸名順</button>
                    <button id="sort-by-kouji-btn" class="px-3 py-1 text-sm font-semibold text-gray-700 bg-gray-200 rounded-md shadow-sm">工事番号順</button>
                </div>
                <div id="well-list-actions" class="hidden flex items-center space-x-2">
                    <button id="export-latest-btn" class="bg-indigo-600 text-white font-semibold px-3 py-1 rounded-md text-sm hover:bg-indigo-700">最新値CSV</button>
                    <button id="export-all-btn" class="bg-purple-600 text-white font-semibold px-3 py-1 rounded-md text-sm hover:bg-purple-700">全データCSV</button>
                    <button id="delete-selected-wells-btn" class="bg-red-600 text-white font-semibold px-3 py-1 rounded-md text-sm hover:bg-red-700">選択を削除</button>
                </div>
            </div>
            <div class="max-h-[70vh] overflow-y-auto">
                <ul id="well-list-container" class="space-y-2">
                    <!-- 井戸リストはここに動的に挿入されます -->
                </ul>
            </div>
        </div>
    </div>
    
    <!-- データ修正モーダル -->
    <div id="edit-measurement-modal" class="modal-hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[1005]">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <h3 id="edit-measurement-title" class="text-lg leading-6 font-medium text-gray-900 mb-4"></h3>
            <div class="space-y-4">
                <input type="hidden" id="edit-measurement-id">
                <input type="hidden" id="edit-measurement-type">
                <div>
                    <label for="edit-measurement-time" class="block text-sm font-medium text-gray-700">観測日時</label>
                    <input type="datetime-local" id="edit-measurement-time" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                </div>
                 <div>
                    <label id="edit-measurement-label" for="edit-measurement-value" class="block text-sm font-medium text-gray-700"></label>
                    <input type="number" step="0.01" id="edit-measurement-value" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                </div>
            </div>
            <div class="items-center px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse mt-4">
                <button id="save-edited-measurement-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                    更新
                </button>
                <button id="close-edit-measurement-modal-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">
                    キャンセル
                </button>
            </div>
        </div>
    </div>


    <!-- 削除確認モーダル -->
    <div id="delete-confirm-modal" class="modal-hidden fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-[1004]">
        <div class="relative top-40 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
             <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <h3 id="delete-confirm-title" class="text-lg leading-6 font-medium text-gray-900 mt-2"></h3>
                <div class="mt-2 px-7 py-3">
                    <p id="delete-confirm-message" class="text-sm text-gray-500"></p>
                </div>
                <div class="items-center px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button id="confirm-delete-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                        削除
                    </button>
                    <button id="cancel-delete-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">
                        キャンセル
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- 井戸詳細サイドパネル -->
    <div id="well-details-panel" class="fixed top-0 right-0 h-full w-full md:w-1/3 bg-white shadow-lg z-[1001] p-6 overflow-y-auto slide-out">
        <div class="flex justify-between items-center mb-4">
            <h2 id="well-name" class="text-2xl font-bold text-gray-800"></h2>
            <button id="close-panel-btn" class="text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        
        <div class="mb-6 bg-gray-50 p-4 rounded-lg">
            <div class="flex justify-between items-start">
                 <div>
                    <div class="flex items-center space-x-2 mb-2">
                        <h3 class="text-lg font-semibold text-gray-700">井戸情報</h3>
                        <button id="edit-well-btn" title="井戸情報を修正" class="text-gray-400 hover:text-blue-600">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <p class="text-sm text-gray-600"><strong>ID:</strong> <span id="well-id-details"></span></p>
                    <p class="text-sm text-gray-600"><strong>工事番号:</strong> <span id="well-kouji-bango-details"></span></p>
                    <p class="text-sm text-gray-600"><strong>基準点高さ:</strong> <span id="well-reference-point-height-details"></span> m</p>
                    <p class="text-sm text-gray-600"><strong>所在地:</strong> <span id="well-address"></span></p>
                    <p class="text-sm text-gray-600"><strong>地盤標高:</strong> <span id="well-elevation"></span> m</p>
                </div>
                <div class="text-right">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">ユーザー</h3>
                    <p id="user-id-display" class="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded-full"></p>
                </div>
            </div>
        </div>
        
        <div id="measurement-forms-container">
            <!-- 測定フォームはここに動的に挿入されます -->
        </div>

        <div class="mb-6">
            <div class="flex items-center space-x-2 mb-2">
                <h3 class="text-lg font-semibold text-gray-700">トレンドグラフ</h3>
                <div id="graph-toggle-buttons" class="flex items-center space-x-1">
                    <!-- グラフ切り替えボタンはここに動的に挿入されます -->
                </div>
            </div>
            <canvas id="data-chart"></canvas>
        </div>

        <div>
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-semibold text-gray-700">測定履歴</h3>
                <div class="flex items-center space-x-2">
                    <button id="add-history-btn" class="bg-green-500 text-white text-xs font-semibold px-2 py-1 rounded-md hover:bg-green-600">追加</button>
                    <button id="export-csv-btn" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md hover:bg-gray-300 text-sm font-semibold">CSV</button>
                </div>
            </div>
            <ul id="measurement-list" class="space-y-2"></ul>
        </div>
        
        <div class="mt-8 pt-6 border-t border-gray-200">
             <button id="delete-well-btn" class="w-full flex justify-center items-center space-x-2 bg-red-100 text-red-700 px-4 py-2 rounded-md hover:bg-red-200 font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                <span>この井戸を削除</span>
            </button>
        </div>

    </div>
    
    <div id="offline-indicator" class="hidden fixed bottom-4 left-4 bg-yellow-500 text-white text-sm font-bold py-2 px-4 rounded-full shadow-lg z-[1002]">
        <p>オフラインモードで動作中</p>
    </div>
    
    <div id="sync-indicator" class="hidden fixed bottom-4 right-4 bg-green-500 text-white text-sm font-bold py-2 px-4 rounded-full shadow-lg z-[1002]">
        <p>データを同期しました</p>
    </div>


    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, writeBatch, enableNetwork, disableNetwork, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================================
        // グローバル変数と初期設定
        // =================================================================================
        let db, auth;
        let userId = null;
        let unsubscribeWells = null;
        let unsubscribeMeasurements = null;

        let map;
        let dataChart;
        let currentWell = null;
        let allMeasurementsCache = [];
        let wellMarkersLayer = L.featureGroup();
        let wellMarkers = {};
        let allWellsCache = [];
        let currentDeleteHandler = null;
        let userLocationMarker = null;
        let labelsVisible = false;
        
        const createSvgIcon = (color) => {
            return L.divIcon({
                html: `
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${color}" width="32px" height="32px">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                  </svg>`,
                className: 'leaflet-div-icon',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });
        };
        const defaultIcon = createSvgIcon('#718096');
        const waterLevelIcon = createSvgIcon('#3b82f6');
        const pumpingRateIcon = createSvgIcon('#dc2626');
        const bothIcon = createSvgIcon('#7c3aed');

        // =================================================================================
        // Firebase 初期化と認証
        // =================================================================================
        async function initializeFirebase() {
            try {
                const firebaseConfig = {
                  apiKey: "AIzaSyAYovasyBOIls5q9ZVX7_HeJmeeDD9OcpU",
                  authDomain: "idochousa2025.firebaseapp.com",
                  projectId: "idochousa2025",
                  storageBucket: "idochousa2025.appspot.com",
                  messagingSenderId: "55272688318",
                  appId: "1:55272688318:web:c665ace11cda1a9eeb2cef"
                };

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated User ID:", userId);
                        document.getElementById('user-id-display').textContent = `${userId.substring(0, 8)}...`;
                        
                        initMap();
                        await populateSampleData();
                        listenForWells();
                    } else {
                        console.log("No user signed in.");
                    }
                });

                await signInAnonymously(auth);

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                 if (error.code === 'auth/configuration-not-found') {
                    alert("Firebase認証エラー: 匿名認証が有効になっていません。\n\nFirebaseコンソールの「Authentication」>「Sign-in method」タブで、「匿名」プロバイダを有効にしてください。");
                } else {
                    alert("アプリケーションの初期化に失敗しました。設定を確認してください。");
                }
            }
        }
        
        // =================================================================================
        // アプリケーションの初期設定とPWAサービスワーカーの登録
        // =================================================================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => console.log('ServiceWorker登録成功:', registration.scope))
                    .catch(error => console.log('ServiceWorker登録失敗:', error));
            });
        }
        
        window.addEventListener('online', () => {
            document.getElementById('offline-indicator').classList.add('hidden');
            if(db) enableNetwork(db).then(() => console.log("Network enabled."));
        });
        window.addEventListener('offline', () => {
            document.getElementById('offline-indicator').classList.remove('hidden');
            if(db) disableNetwork(db).then(() => console.log("Network disabled."));
        });
        if (!navigator.onLine) {
            document.getElementById('offline-indicator').classList.remove('hidden');
        }

        // =================================================================================
        // Firestore データ操作
        // =================================================================================
        
        function getCollections() {
            const wellsCollectionRef = collection(db, 'wells');
            const measurementsCollectionRef = collection(db, 'measurements');
            return { wellsCollectionRef, measurementsCollectionRef };
        }

        async function populateSampleData() {
            const { wellsCollectionRef } = getCollections();
            const snapshot = await getDocs(wellsCollectionRef);

            if (snapshot.empty) {
                console.log('Firestoreが空のため、サンプルデータを投入します');
                const wells = [
                    { id: 'well-001', name: 'A-1観測井', kouji_bango: '2025-A-01', reference_point_height: 0.5, address: '東京都千代田区', elevation: 25.5, lat: 35.681236, lng: 139.767125, monitors_water_level: true, monitors_pumping_rate: false },
                    { id: 'well-002', name: 'B-3調査井', kouji_bango: '2025-B-03', reference_point_height: -0.2, address: '神奈川県横浜市', elevation: 15.2, lat: 35.443707, lng: 139.638031, monitors_water_level: true, monitors_pumping_rate: true },
                    { id: 'well-003', name: 'C-5揚水井', kouji_bango: '2025-A-02', reference_point_height: 0.0, address: '埼玉県さいたま市', elevation: 8.9, lat: 35.861729, lng: 139.645485, monitors_water_level: false, monitors_pumping_rate: true }
                ];
                const measurements = [
                    { well_id: 'well-001', type: 'water_level', timestamp: new Date('2025-03-15T10:00:00Z'), water_level_from_ref: 15.73, water_level_from_ground: 15.23, operator_id: 'sample_user' },
                    { well_id: 'well-002', type: 'water_level', timestamp: new Date('2025-04-15T10:00:00Z'), water_level_from_ref: 8.7, water_level_from_ground: 8.5, operator_id: 'sample_user' },
                    { well_id: 'well-002', type: 'pumping_rate', timestamp: new Date('2025-04-15T10:05:00Z'), value: 120, operator_id: 'sample_user' },
                    { well_id: 'well-003', type: 'pumping_rate', timestamp: new Date('2025-05-15T10:00:00Z'), value: 250, operator_id: 'sample_user' },
                ];

                const { measurementsCollectionRef } = getCollections();
                const batch = writeBatch(db);
                wells.forEach(well => {
                    const docRef = doc(wellsCollectionRef, well.id);
                    batch.set(docRef, well);
                });
                measurements.forEach(m => {
                    const docRef = doc(collection(measurementsCollectionRef)); 
                    batch.set(docRef, m);
                });
                await batch.commit();
                console.log("サンプルデータを投入しました。");
            } else {
                console.log('既存のデータがあるため、サンプル投入をスキップします');
            }
        }
        
        function listenForWells() {
            if (unsubscribeWells) unsubscribeWells(); 
            
            const { wellsCollectionRef } = getCollections();
            unsubscribeWells = onSnapshot(wellsCollectionRef, (snapshot) => {
                const wells = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allWellsCache = wells; 
                updateMapMarkers(wells);
            }, (error) => {
                console.error("Error listening for well updates:", error);
            });
        }
        
        function updateMapMarkers(wells) {
            wellMarkersLayer.clearLayers(); 
            wellMarkers = {};
            
            if(wells.length === 0) return;

            wells.forEach(well => {
                if (well.lat == null || well.lng == null) return;
                
                let icon = defaultIcon;
                const monitorsWater = well.monitors_water_level;
                const monitorsPumping = well.monitors_pumping_rate;

                if (monitorsWater && monitorsPumping) {
                    icon = bothIcon;
                } else if (monitorsWater) {
                    icon = waterLevelIcon;
                } else if (monitorsPumping) {
                    icon = pumpingRateIcon;
                }
                
                const marker = L.marker([well.lat, well.lng], { icon: icon });
                marker.bindPopup(`<b>${well.name}</b>`).on('click', () => {
                    openWellDetailsPanel(well);
                });

                marker.bindTooltip(well.name, {
                    permanent: false,
                    direction: 'top',
                    offset: [0, -15],
                    className: 'well-label'
                });
                
                if (labelsVisible) {
                    marker.openTooltip();
                }

                wellMarkersLayer.addLayer(marker);
                wellMarkers[well.id] = marker; 
            });

            if (Object.keys(wellMarkers).length > 0 && map.getZoom() < 5) {
                 map.fitBounds(wellMarkersLayer.getBounds(), { padding: [50, 50] });
            }
        }


        // =================================================================================
        // 地図の初期化
        // =================================================================================
        
        function initMap() {
            if (map) return;
            
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            });

            const gsiPaleLayer = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
                attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"
            });
            
            const gsiOrtLayer = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg', {
                attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"
            });

            map = L.map('map', {
                center: [35.681236, 139.767125],
                zoom: 10,
                layers: [gsiPaleLayer] // 初期表示レイヤー
            });

            const baseLayers = {
                "地理院地図": gsiPaleLayer,
                "標準地図": osmLayer,
                "空中写真": gsiOrtLayer
            };

            const overlayLayers = {
                "井戸マーカー": wellMarkersLayer
            };
            
            L.control.layers(baseLayers, overlayLayers).addTo(map);

            wellMarkersLayer.addTo(map);
        }

        // =================================================================================
        // UI操作（サイドパネル、チャート、リスト）
        // =================================================================================

        function openWellDetailsPanel(well) {
            if (unsubscribeMeasurements) unsubscribeMeasurements();

            currentWell = well;
            const panel = document.getElementById('well-details-panel');
            document.getElementById('well-name').textContent = well.name;
            document.getElementById('well-id-details').textContent = well.id;
            document.getElementById('well-kouji-bango-details').textContent = well.kouji_bango || 'N/A';
            document.getElementById('well-reference-point-height-details').textContent = well.reference_point_height != null ? well.reference_point_height.toFixed(2) : 'N/A';
            document.getElementById('well-address').textContent = well.address || 'N/A';
            document.getElementById('well-elevation').textContent = well.elevation != null ? well.elevation.toFixed(2) : 'N/A';
            
            setupMeasurementForms(well);

            panel.classList.remove('slide-out');
            panel.classList.add('slide-in');
            
            const { measurementsCollectionRef } = getCollections();
            const q = query(measurementsCollectionRef, where("well_id", "==", well.id));
            
            unsubscribeMeasurements = onSnapshot(q, (snapshot) => {
                allMeasurementsCache = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                allMeasurementsCache.forEach(m => {
                    if (m.timestamp && m.timestamp.toDate) m.timestamp = m.timestamp.toDate();
                });
                allMeasurementsCache.sort((a,b) => b.timestamp - a.timestamp);
                
                updateMeasurementList(allMeasurementsCache);
                updateGraphToggleButton(allMeasurementsCache);
            });
        }
        
        function closePanel() {
            if (unsubscribeMeasurements) unsubscribeMeasurements();
            const panel = document.getElementById('well-details-panel');
            panel.classList.remove('slide-in');
            panel.classList.add('slide-out');
            currentWell = null;
        }

        function updateMeasurementList(measurements) {
            const listEl = document.getElementById('measurement-list');
            listEl.innerHTML = '';
            
            if (measurements.length === 0) {
                listEl.innerHTML = '<li class="text-gray-500">測定データがありません。</li>';
                return;
            }

            measurements.forEach(m => {
                const li = document.createElement('li');
                li.className = 'p-3 bg-white border rounded-md flex items-center';
                const date = new Date(m.timestamp).toLocaleString('ja-JP');
                const operator = m.operator_id ? m.operator_id.substring(0,8) : 'N/A';
                
                let valueDisplay;
                if (m.type === 'water_level') {
                    const groundLevel = m.water_level_from_ground != null ? m.water_level_from_ground.toFixed(2) : '計算不可';
                    valueDisplay = `<p class="font-semibold text-gray-800">${groundLevel} m (地表から)</p>`;
                } else if (m.type === 'pumping_rate') {
                    valueDisplay = `<p class="font-semibold text-green-700">${m.value} L/分 (揚水量)</p>`;
                }

                li.innerHTML = `
                    <div class="flex-grow">
                        ${valueDisplay}
                        <p class="text-sm text-gray-500">${date}</p>
                    </div>
                    <div class="text-xs text-gray-400 mr-4" title="測定者: ${m.operator_id}">
                        ${operator}
                    </div>
                    <button class="edit-measurement-btn text-blue-500 hover:text-blue-700 px-1" data-measurement-id="${m.id}">修正</button>
                    <button class="delete-measurement-btn text-red-500 hover:text-red-700 px-1" data-measurement-id="${m.id}">削除</button>
                `;
                listEl.appendChild(li);
                li.querySelector('.edit-measurement-btn').addEventListener('click', () => openEditMeasurementModal(m));
                li.querySelector('.delete-measurement-btn').addEventListener('click', () => {
                    showDeleteConfirm({
                        title: 'この測定データを削除しますか？',
                        message: 'この操作は元に戻せません。',
                        handler: () => deleteMeasurement(m.id)
                    });
                });
            });
        }
        
        function updateDataChart(dataType, measurements) {
            const ctx = document.getElementById('data-chart').getContext('2d');
            const dataToShow = measurements.filter(m => m.type === dataType).sort((a,b) => a.timestamp - b.timestamp);
            
            let chartLabel, yAxisLabel, dataValues, color;

            if(dataType === 'water_level') {
                chartLabel = '地表からの水位 (m)';
                yAxisLabel = '地表からの水位 (m)';
                dataValues = dataToShow.map(m => m.water_level_from_ground);
                color = 'rgb(59, 130, 246)';
            } else {
                chartLabel = '揚水量 (L/分)';
                yAxisLabel = '揚水量 (L/分)';
                dataValues = dataToShow.map(m => m.value);
                color = 'rgb(22, 163, 74)';
            }
            
            const labels = dataToShow.map(m => new Date(m.timestamp).toLocaleDateString('ja-JP'));
            
            if (dataChart) {
                dataChart.destroy();
            }

            dataChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: chartLabel,
                        data: dataValues,
                        borderColor: color,
                        backgroundColor: color.replace(')', ', 0.1)').replace('rgb', 'rgba'),
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: { 
                    responsive: true, 
                    scales: { 
                        y: { 
                            title: { display: true, text: yAxisLabel },
                            reverse: dataType === 'water_level'
                        } 
                    }, 
                    plugins: { legend: { display: false } } 
                }
            });
        }
        
        // =================================================================================
        // イベントリスナーとデータ処理
        // =================================================================================
        function setupMeasurementForms(well) {
            const container = document.getElementById('measurement-forms-container');
            container.innerHTML = '';
            
            if (well.monitors_water_level) {
                container.innerHTML += `
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">新規水位測定</h3>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="water-level-input" step="0.01" placeholder="基準点からの水位 (m)" class="flex-grow p-2 border rounded-md">
                            <button id="add-water-level-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold shadow">保存</button>
                        </div>
                    </div>
                `;
            }
            if (well.monitors_pumping_rate) {
                 container.innerHTML += `
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">新規揚水量測定</h3>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="pumping-rate-input" step="0.1" placeholder="揚水量 (L/分)" class="flex-grow p-2 border rounded-md">
                            <button id="add-pumping-rate-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 font-semibold shadow">保存</button>
                        </div>
                    </div>
                `;
            }

            if(well.monitors_water_level) document.getElementById('add-water-level-btn').addEventListener('click', handleAddMeasurement);
            if(well.monitors_pumping_rate) document.getElementById('add-pumping-rate-btn').addEventListener('click', handleAddMeasurement);
        }

        async function handleAddMeasurement(event, measurementData = null) {
            let type, value, timestamp;
            
            if (measurementData) { // For adding historical data
                type = measurementData.type;
                value = measurementData.value;
                timestamp = measurementData.timestamp;
            } else { // For new data
                type = event.target.id === 'add-water-level-btn' ? 'water_level' : 'pumping_rate';
                const inputEl = document.getElementById(type === 'water_level' ? 'water-level-input' : 'pumping-rate-input');
                value = parseFloat(inputEl.value);
                timestamp = serverTimestamp();
                if (isNaN(value)) { alert(`有効な${type === 'water_level' ? '水位' : '揚水量'}を入力してください。`); return; }
                inputEl.value = '';
            }

            let measurement = {
                well_id: currentWell.id,
                timestamp: timestamp,
                operator_id: userId,
                type: type
            };

            if (type === 'water_level') {
                const refHeight = currentWell.reference_point_height || 0;
                measurement.water_level_from_ref = value;
                measurement.water_level_from_ground = value - refHeight;
            } else {
                measurement.value = value;
            }

            const { measurementsCollectionRef } = getCollections();
            try {
                await addDoc(measurementsCollectionRef, measurement);
                console.log("測定データを保存しました。");
            } catch (error) {
                console.error("測定データの保存に失敗:", error);
                alert("データの保存に失敗しました。");
            }
        }
        
        document.getElementById('close-panel-btn').addEventListener('click', closePanel);

        // =================================================================================
        // データインポート/エクスポート/追加/削除機能
        // =================================================================================
        const importModal = document.getElementById('import-modal');
        const openImportModalBtn = document.getElementById('open-import-modal-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const wellFormModal = document.getElementById('well-form-modal');
        const openAddWellModalBtn = document.getElementById('open-add-well-modal-btn');
        const deleteWellBtn = document.getElementById('delete-well-btn');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const wellListModal = document.getElementById('well-list-modal');
        const openWellListModalBtn = document.getElementById('open-well-list-modal-btn');
        const editMeasurementModal = document.getElementById('edit-measurement-modal');
        const editWellBtn = document.getElementById('edit-well-btn');
        const locateMeBtn = document.getElementById('locate-me-btn');
        const toggleLabelsBtn = document.getElementById('toggle-labels-btn');
        const addHistoryBtn = document.getElementById('add-history-btn');

        // --- インポート関連 ---
        openImportModalBtn.addEventListener('click', () => importModal.classList.remove('modal-hidden'));
        document.getElementById('close-import-modal-btn').addEventListener('click', () => importModal.classList.add('modal-hidden'));
        document.getElementById('select-file-btn').addEventListener('click', () => document.getElementById('csv-file-input').click());
        document.getElementById('csv-file-input').addEventListener('change', handleFileSelect);
        
        // --- エクスポート関連 ---
        exportCsvBtn.addEventListener('click', handleExportCSV);
        document.getElementById('export-latest-btn').addEventListener('click', () => handleBulkExport('latest'));
        document.getElementById('export-all-btn').addEventListener('click', () => handleBulkExport('all'));

        // --- 井戸追加・編集関連 ---
        openAddWellModalBtn.addEventListener('click', () => openWellForm('add'));
        editWellBtn.addEventListener('click', () => openWellForm('edit', currentWell));
        document.getElementById('close-well-form-modal-btn').addEventListener('click', () => wellFormModal.classList.add('modal-hidden'));
        document.getElementById('save-well-btn').addEventListener('click', handleSaveWell);
        document.getElementById('select-location-btn').addEventListener('click', handleSelectLocationOnMap);

        // --- 井戸削除関連 ---
        deleteWellBtn.addEventListener('click', () => {
            showDeleteConfirm({
                title: 'この井戸を削除しますか？',
                message: `井戸「${currentWell.name}」と、関連する全ての測定データが永久に削除されます。この操作は元に戻せません。`,
                handler: handleDeleteWell
            });
        });
        document.getElementById('cancel-delete-btn').addEventListener('click', () => {
            deleteConfirmModal.classList.add('modal-hidden');
            currentDeleteHandler = null;
        });
        document.getElementById('confirm-delete-btn').addEventListener('click', () => {
            if (typeof currentDeleteHandler === 'function') {
                currentDeleteHandler();
            }
        });

        // --- 井戸一覧関連 ---
        openWellListModalBtn.addEventListener('click', handleOpenWellList);
        document.getElementById('close-well-list-modal-btn').addEventListener('click', () => wellListModal.classList.add('modal-hidden'));
        document.getElementById('sort-by-name-btn').addEventListener('click', () => renderWellList('name'));
        document.getElementById('sort-by-kouji-btn').addEventListener('click', () => renderWellList('kouji_bango'));
        document.getElementById('well-list-container').addEventListener('change', (e) => {
            if(e.target.matches('.well-checkbox')) {
                const checkedCount = document.querySelectorAll('.well-checkbox:checked').length;
                document.getElementById('well-list-actions').classList.toggle('hidden', checkedCount === 0);
            }
        });
        document.getElementById('delete-selected-wells-btn').addEventListener('click', handleBulkDelete);

        // --- データ修正関連 ---
        document.getElementById('close-edit-measurement-modal-btn').addEventListener('click', () => editMeasurementModal.classList.add('modal-hidden'));
        document.getElementById('save-edited-measurement-btn').addEventListener('click', handleUpdateMeasurement);
        addHistoryBtn.addEventListener('click', () => openEditMeasurementModal(null));

        // --- 現在地表示・ラベル表示関連 ---
        locateMeBtn.addEventListener('click', handleLocateMe);
        toggleLabelsBtn.addEventListener('click', handleToggleLabels);

        // --- 実装 ---
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                try {
                    const data = parseCSV(text);
                    importDataToDB(data);
                } catch (error) {
                    const importStatus = document.getElementById('import-status');
                    importStatus.textContent = `エラー: ${error.message}`;
                    importStatus.className = 'mt-2 text-sm text-red-600';
                }
            };
            reader.readAsText(file);
        }

        function parseCSV(text) {
            const lines = text.trim().split(/\r?\n/);
            if (lines.length < 2) throw new Error("CSVファイルにデータがありません。");
            const header = lines[0].split(',').map(h => h.trim());
            const requiredHeaders = ['well_id', 'well_name', 'lat', 'lng'];
            for(const req of requiredHeaders){
                if(!header.includes(req)) throw new Error(`必須ヘッダーが見つかりません: ${req}`);
            }
            return lines.slice(1).map(line => {
                const values = line.split(',');
                const obj = {};
                header.forEach((h, i) => {
                    obj[h] = values[i] ? values[i].trim() : '';
                });
                return obj;
            });
        }

        async function importDataToDB(data) {
            const importStatus = document.getElementById('import-status');
            importStatus.textContent = "インポート処理中...";
            importStatus.className = 'mt-2 text-sm text-gray-700';

            const { wellsCollectionRef } = getCollections();
            const batch = writeBatch(db);

            data.forEach(row => {
                 const lat = parseFloat(row.lat);
                const lng = parseFloat(row.lng);
                const elevation = row.elevation ? parseFloat(row.elevation) : null;
                const refHeight = row.reference_point_height ? parseFloat(row.reference_point_height) : 0;
                
                if (isNaN(lat) || isNaN(lng)) return;

                const wellData = {
                    name: row.well_name,
                    kouji_bango: row.kouji_bango || '',
                    reference_point_height: isNaN(refHeight) ? 0 : refHeight,
                    monitors_water_level: row.monitors_water_level === 'true',
                    monitors_pumping_rate: row.monitors_pumping_rate === 'true',
                    lat, lng,
                    address: row.address || '',
                    elevation: isNaN(elevation) ? null : elevation
                };
                const docRef = doc(wellsCollectionRef, row.well_id);
                batch.set(docRef, wellData);
            });

            try {
                await batch.commit();
                importStatus.textContent = `${data.length}件の井戸データをインポートしました。`;
                importStatus.className = 'mt-2 text-sm text-green-600';
            } catch (error) {
                 importStatus.textContent = `データベースエラー: ${error.message}`;
                importStatus.className = 'mt-2 text-sm text-red-600';
            } finally {
                document.getElementById('csv-file-input').value = '';
            }
        }

        async function handleExportCSV() {
            if (!currentWell) return;
            const { measurementsCollectionRef } = getCollections();
            const q = query(measurementsCollectionRef, where("well_id", "==", currentWell.id));
            const querySnapshot = await getDocs(q);
            
            const measurements = querySnapshot.docs.map(doc => {
                const data = doc.data();
                if (data.timestamp && data.timestamp.toDate) data.timestamp = data.timestamp.toDate();
                return data;
            }).sort((a,b) => a.timestamp - b.timestamp);
            
            if (measurements.length === 0) {
                alert('エクスポートする測定データがありません。');
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += "測定日時,測定種別,基準点からの水位(m),地表からの水位(m),揚水量(L/分),測定者ID\r\n";
            measurements.forEach(row => {
                const date = new Date(row.timestamp).toLocaleString('ja-JP');
                const type = row.type === 'water_level' ? '水位' : '揚水量';
                const level_ref = row.water_level_from_ref != null ? row.water_level_from_ref.toFixed(2) : '';
                const level_ground = row.water_level_from_ground != null ? row.water_level_from_ground.toFixed(2) : '';
                const pumping_rate = row.value != null ? row.value : '';
                const operator = row.operator_id || '';
                csvContent += `"${date}","${type}",${level_ref},${level_ground},${pumping_rate},"${operator}"\r\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${currentWell.name}_測定履歴.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        async function handleBulkExport(type) {
             const checkedBoxes = document.querySelectorAll('.well-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('エクスポートする井戸を選択してください。');
                return;
            }
            const idsToExport = Array.from(checkedBoxes).map(cb => cb.value);
            const { measurementsCollectionRef } = getCollections();

            let allMeasurements = [];
            for (const id of idsToExport) {
                const q = query(measurementsCollectionRef, where("well_id", "==", id));
                const snapshot = await getDocs(q);
                snapshot.forEach(doc => {
                    const data = doc.data();
                     if (data.timestamp && data.timestamp.toDate) data.timestamp = data.timestamp.toDate();
                    allMeasurements.push({well_id: id, ...data});
                });
            }
            
            if (allMeasurements.length === 0) {
                alert('エクスポートする測定データがありません。');
                return;
            }

            let dataToExport;
            if (type === 'latest') {
                const latestData = {};
                allMeasurements.forEach(m => {
                    const key = `${m.well_id}-${m.type}`;
                    if (!latestData[key] || m.timestamp > latestData[key].timestamp) {
                        latestData[key] = m;
                    }
                });
                dataToExport = Object.values(latestData);
            } else {
                dataToExport = allMeasurements;
            }

            dataToExport.sort((a,b) => a.well_id.localeCompare(b.well_id) || (a.timestamp - b.timestamp));
            
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += "井戸ID,測定日時,測定種別,基準点からの水位(m),地表からの水位(m),揚水量(L/分),測定者ID\r\n";
             dataToExport.forEach(row => {
                const date = new Date(row.timestamp).toLocaleString('ja-JP');
                const type = row.type === 'water_level' ? '水位' : '揚水量';
                const level_ref = row.water_level_from_ref != null ? row.water_level_from_ref.toFixed(2) : '';
                const level_ground = row.water_level_from_ground != null ? row.water_level_from_ground.toFixed(2) : '';
                const pumping_rate = row.value != null ? row.value : '';
                const operator = row.operator_id || '';
                csvContent += `${row.well_id},"${date}","${type}",${level_ref},${level_ground},${pumping_rate},"${operator}"\r\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `一括エクスポート_${timestamp}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function handleSelectLocationOnMap() {
            wellFormModal.classList.add('modal-hidden');
            const instruction = document.createElement('div');
            instruction.className = 'fixed top-4 left-1/2 -translate-x-1/2 bg-white text-gray-800 p-3 rounded-lg shadow-lg z-[1005]';
            instruction.innerHTML = 'マーカーをドラッグして位置を調整し、<br>左下のボタンで確定してください。';
            document.body.appendChild(instruction);
            
            const tempMarker = L.marker(map.getCenter(), { draggable: true }).addTo(map);

            const ConfirmControl = L.Control.extend({
                onAdd: function(map) {
                    const button = L.DomUtil.create('button', 'bg-green-600 text-white font-bold py-2 px-4 rounded shadow-lg');
                    button.innerText = 'この位置で確定';
                    L.DomEvent.on(button, 'click', (e) => {
                        L.DomEvent.stop(e);
                        finalizeSelection();
                    });
                    return button;
                },
            });
            const confirmButton = new ConfirmControl({ position: 'bottomleft' });
            map.addControl(confirmButton);
            const finalizeSelection = () => {
                const pos = tempMarker.getLatLng();
                document.getElementById('well-form-lat').value = pos.lat.toFixed(6);
                document.getElementById('well-form-lng').value = pos.lng.toFixed(6);
                map.removeControl(confirmButton);
                map.removeLayer(tempMarker);
                if(document.body.contains(instruction)) document.body.removeChild(instruction);
                wellFormModal.classList.remove('modal-hidden');
            }
        }
        
        function openWellForm(mode, wellData = null) {
            const form = document.getElementById('well-form');
            form.reset();
            const title = document.getElementById('well-form-title');
            const idInput = document.getElementById('well-form-id');
            const modeInput = document.getElementById('well-form-mode');
            
            if (mode === 'add') {
                title.textContent = '新規井戸の追加';
                modeInput.value = 'add';
                idInput.value = `well-${Date.now()}`;
                idInput.readOnly = false;
            } else if (mode === 'edit' && wellData) {
                title.textContent = '井戸情報の修正';
                modeInput.value = 'edit';
                idInput.value = wellData.id;
                idInput.readOnly = true;
                document.getElementById('well-form-name').value = wellData.name || '';
                document.getElementById('well-form-kouji-bango').value = wellData.kouji_bango || '';
                document.getElementById('well-form-reference-point-height').value = wellData.reference_point_height || 0;
                document.getElementById('well-form-monitors-water-level').checked = !!wellData.monitors_water_level;
                document.getElementById('well-form-monitors-pumping-rate').checked = !!wellData.monitors_pumping_rate;
                document.getElementById('well-form-lat').value = wellData.lat || '';
                document.getElementById('well-form-lng').value = wellData.lng || '';
                document.getElementById('well-form-address').value = wellData.address || '';
                document.getElementById('well-form-elevation').value = wellData.elevation || '';
            }
            wellFormModal.classList.remove('modal-hidden');
        }
        
        async function handleSaveWell() {
            const mode = document.getElementById('well-form-mode').value;
            const id = document.getElementById('well-form-id').value.trim();
            const name = document.getElementById('well-form-name').value.trim();
            const kouji_bango = document.getElementById('well-form-kouji-bango').value.trim();
            const reference_point_height = document.getElementById('well-form-reference-point-height').value.trim();
            const monitors_water_level = document.getElementById('well-form-monitors-water-level').checked;
            const monitors_pumping_rate = document.getElementById('well-form-monitors-pumping-rate').checked;
            const lat = parseFloat(document.getElementById('well-form-lat').value);
            const lng = parseFloat(document.getElementById('well-form-lng').value);
            const address = document.getElementById('well-form-address').value.trim();
            const elevation = document.getElementById('well-form-elevation').value.trim();
            const errorDiv = document.getElementById('well-form-error');
            
            errorDiv.textContent = '';
            if (!id || !name || isNaN(lat) || isNaN(lng)) {
                errorDiv.textContent = '必須項目（ID, 名前, 緯度, 経度）をすべて入力してください。';
                return;
            }

            const wellData = {
                name, kouji_bango, lat, lng, address,
                monitors_water_level, monitors_pumping_rate,
                reference_point_height: reference_point_height ? parseFloat(reference_point_height) : 0,
                elevation: elevation ? parseFloat(elevation) : null
            };
            
            const { wellsCollectionRef } = getCollections();
            const docRef = doc(wellsCollectionRef, id);

            try {
                if (mode === 'add') {
                    const existingDoc = await getDoc(docRef);
                    if (existingDoc.exists()) {
                         errorDiv.textContent = 'エラー: この井戸IDは既に使用されています。';
                         return;
                    }
                }
                await setDoc(docRef, wellData, { merge: mode === 'edit' });
                console.log('井戸情報を保存しました:', wellData);
                wellFormModal.classList.add('modal-hidden');
                if (mode === 'edit') {
                    closePanel();
                    openWellDetailsPanel({id, ...wellData});
                }
            } catch(e) {
                errorDiv.textContent = `データベースエラー: ${e.message}`;
            }
        }

        async function handleBulkDelete() {
            const checkedBoxes = document.querySelectorAll('.well-checkbox:checked');
            if (checkedBoxes.length === 0) return;

            showDeleteConfirm({
                title: `${checkedBoxes.length}件の井戸を削除しますか？`,
                message: '選択された全ての井戸と、それらに関連する全ての測定データが永久に削除されます。この操作は元に戻せません。',
                handler: async () => {
                    const idsToDelete = Array.from(checkedBoxes).map(cb => cb.value);
                    await deleteWells(idsToDelete);
                    wellListModal.classList.add('modal-hidden');
                }
            });
        }

        async function handleDeleteWell() {
            if (!currentWell) return;
            await deleteWells([currentWell.id]);
            closePanel();
        }

        async function deleteWells(wellIds) {
            const { wellsCollectionRef, measurementsCollectionRef } = getCollections();
            const batch = writeBatch(db);

            for (const id of wellIds) {
                batch.delete(doc(wellsCollectionRef, id));
                const q = query(measurementsCollectionRef, where("well_id", "==", id));
                const snapshot = await getDocs(q);
                snapshot.forEach(doc => batch.delete(doc.ref));
            }
            
            try {
                await batch.commit();
                console.log(`${wellIds.length}件の井戸を削除しました。`);
                deleteConfirmModal.classList.add('modal-hidden');
            } catch (e) {
                 alert('削除中にエラーが発生しました。');
                 console.error(e);
            }
        }


        function handleOpenWellList() {
            renderWellList('name');
            wellListModal.classList.remove('modal-hidden');
        }

        function renderWellList(sortBy) {
            const listContainer = document.getElementById('well-list-container');
            const sortByNameBtn = document.getElementById('sort-by-name-btn');
            const sortByKoujiBtn = document.getElementById('sort-by-kouji-btn');
            listContainer.innerHTML = '';
            
            let sortedWells = [...allWellsCache];

            if (sortBy === 'name') {
                sortedWells.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ja'));
                sortByNameBtn.classList.replace('bg-gray-200', 'bg-blue-600');
                sortByNameBtn.classList.replace('text-gray-700', 'text-white');
                sortByKoujiBtn.classList.replace('bg-blue-600', 'bg-gray-200');
                sortByKoujiBtn.classList.replace('text-white', 'text-gray-700');
            } else if (sortBy === 'kouji_bango') {
                sortedWells.sort((a, b) => {
                    const koujiA = a.kouji_bango || '';
                    const koujiB = b.kouji_bango || '';
                    if (koujiA === '' && koujiB !== '') return 1;
                    if (koujiA !== '' && koujiB === '') return -1;
                    return koujiA.localeCompare(koujiB, undefined, { numeric: true });
                });
                sortByKoujiBtn.classList.replace('bg-gray-200', 'bg-blue-600');
                sortByKoujiBtn.classList.replace('text-gray-700', 'text-white');
                sortByNameBtn.classList.replace('bg-blue-600', 'bg-gray-200');
                sortByNameBtn.classList.replace('text-white', 'text-gray-700');
            }

            if (sortedWells.length === 0) {
                listContainer.innerHTML = '<li class="text-gray-500 text-center">登録されている井戸はありません。</li>';
            } else {
                sortedWells.forEach(well => {
                    const li = document.createElement('li');
                    li.className = 'p-3 hover:bg-gray-100 rounded-md flex items-center space-x-4 border-b';
                    const koujiDisplay = well.kouji_bango ? `<p class="text-xs text-green-700 font-semibold">工事番号: ${well.kouji_bango}</p>` : '';
                    li.innerHTML = `
                        <input type="checkbox" value="${well.id}" class="well-checkbox h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <div class="flex-grow cursor-pointer" data-well-id="${well.id}">
                             <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-semibold text-gray-800">${well.name}</p>
                                    <p class="text-sm text-gray-500">${well.id}</p>
                                </div>
                                ${koujiDisplay}
                            </div>
                        </div>
                        <button class="edit-well-list-btn text-gray-400 hover:text-blue-600 p-1" data-well-id="${well.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    li.querySelector('[data-well-id]').addEventListener('click', () => jumpToWell(well));
                    li.querySelector('.edit-well-list-btn').addEventListener('click', () => {
                        wellListModal.classList.add('modal-hidden');
                        openWellForm('edit', well);
                    });
                    listContainer.appendChild(li);
                });
            }
        }

        function jumpToWell(well) {
            wellListModal.classList.add('modal-hidden');
            if (well) {
                map.flyTo([well.lat, well.lng], 16);
                const marker = wellMarkers[well.id];
                if(marker) {
                    setTimeout(() => marker.openPopup(), 1000);
                }
            }
        }

        function openEditMeasurementModal(measurement) {
            const modal = document.getElementById('edit-measurement-modal');
            const title = document.getElementById('edit-measurement-title');
            const label = document.getElementById('edit-measurement-label');
            const valueInput = document.getElementById('edit-measurement-value');
            const idInput = document.getElementById('edit-measurement-id');
            const typeInput = document.getElementById('edit-measurement-type');

            if (measurement) { // Edit existing
                title.textContent = "測定データの修正";
                idInput.value = measurement.id;
                typeInput.value = measurement.type;
                if (measurement.type === 'water_level') {
                    label.textContent = '基準点からの水位 (m)';
                    valueInput.value = measurement.water_level_from_ref;
                } else {
                    label.textContent = '揚水量 (L/分)';
                    valueInput.value = measurement.value;
                }
                const date = new Date(measurement.timestamp);
                date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
                document.getElementById('edit-measurement-time').value = date.toISOString().slice(0, 16);
            } else { // Add new history
                title.textContent = "過去データの追加";
                idInput.value = ''; // new doc
                typeInput.value = ''; // User will select
                label.textContent = '測定値';
                valueInput.value = '';
                document.getElementById('edit-measurement-time').value = new Date().toISOString().slice(0, 16);
                
                let type;
                if (currentWell.monitors_water_level && currentWell.monitors_pumping_rate) {
                    type = prompt("測定種別を入力してください ('水位' または '揚水量'):");
                } else if (currentWell.monitors_water_level) {
                    type = '水位';
                } else if (currentWell.monitors_pumping_rate) {
                    type = '揚水量';
                } else {
                    alert('この井戸は観測種別が設定されていません。');
                    return;
                }

                if (type === '水位') {
                    typeInput.value = 'water_level';
                     label.textContent = '基準点からの水位 (m)';
                } else if (type === '揚水量') {
                    typeInput.value = 'pumping_rate';
                     label.textContent = '揚水量 (L/分)';
                } else {
                    alert('無効な種別です。');
                    return;
                }
            }

            modal.classList.remove('modal-hidden');
        }

        async function handleUpdateMeasurement() {
            const id = document.getElementById('edit-measurement-id').value;
            const type = document.getElementById('edit-measurement-type').value;
            const value = parseFloat(document.getElementById('edit-measurement-value').value);
            const timeStr = document.getElementById('edit-measurement-time').value;

            if (isNaN(value) || !timeStr) {
                alert('有効な値を入力してください。');
                return;
            }
            
            const timestamp = Timestamp.fromDate(new Date(timeStr));
            const { measurementsCollectionRef } = getCollections();
            
            let dataToUpdate = { timestamp, type, operator_id: userId, well_id: currentWell.id };

            if (type === 'water_level') {
                const refHeight = currentWell.reference_point_height || 0;
                dataToUpdate.water_level_from_ref = value;
                dataToUpdate.water_level_from_ground = value - refHeight;
            } else {
                 dataToUpdate.value = value;
            }

            try {
                if(id) { // Update existing
                    const docRef = doc(measurementsCollectionRef, id);
                    await updateDoc(docRef, dataToUpdate);
                } else { // Add new
                    await addDoc(measurementsCollectionRef, dataToUpdate);
                }
                console.log('データを保存しました。');
                document.getElementById('edit-measurement-modal').classList.add('modal-hidden');
            } catch (e) {
                alert('データの保存に失敗しました。');
                console.error(e);
            }
        }
        
        async function deleteMeasurement(id) {
            const { measurementsCollectionRef } = getCollections();
            try {
                await deleteDoc(doc(measurementsCollectionRef, id));
                console.log('測定データを削除しました。');
                 deleteConfirmModal.classList.add('modal-hidden');
            } catch(e) {
                alert('削除に失敗しました。');
                console.error(e);
            }
        }

        function showDeleteConfirm(options) {
            document.getElementById('delete-confirm-title').textContent = options.title;
            document.getElementById('delete-confirm-message').textContent = options.message;
            currentDeleteHandler = options.handler;
            deleteConfirmModal.classList.remove('modal-hidden');
        }

        function handleLocateMe() {
            if (!navigator.geolocation) {
                alert('お使いのブラウザは位置情報サービスに対応していません。');
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    map.flyTo([latitude, longitude], 16);
                    if (userLocationMarker) {
                        userLocationMarker.setLatLng([latitude, longitude]);
                    } else {
                        userLocationMarker = L.circleMarker([latitude, longitude], {
                            radius: 8,
                            color: '#1d4ed8',
                            fillColor: '#3b82f6',
                            fillOpacity: 0.8
                        }).addTo(map);
                    }
                     userLocationMarker.bindPopup('あなたの現在地').openPopup();
                },
                (err) => {
                    console.warn(`ERROR(${err.code}): ${err.message}`);
                    alert('現在地の取得に失敗しました。ブラウザの位置情報サービスが有効になっているか確認してください。');
                }
            );
        }

        function handleToggleLabels() {
            labelsVisible = !labelsVisible;
            toggleLabelsBtn.classList.toggle('bg-blue-200', labelsVisible);

            wellMarkersLayer.eachLayer(marker => {
                if (labelsVisible) {
                    marker.openTooltip();
                } else {
                    marker.closeTooltip();
                }
            });
        }
        
        function updateGraphToggleButton(measurements) {
            const container = document.getElementById('graph-toggle-buttons');
            container.innerHTML = '';
            const hasWaterLevel = measurements.some(m => m.type === 'water_level');
            const hasPumpingRate = measurements.some(m => m.type === 'pumping_rate');

            let firstActiveType = '';
            
            if (hasWaterLevel) {
                firstActiveType = 'water_level';
                container.innerHTML += `<button id="show-water-level-graph" class="graph-toggle-btn px-2 py-1 text-sm rounded-md">水位</button>`;
            }
            if (hasPumpingRate) {
                if (!firstActiveType) firstActiveType = 'pumping_rate';
                 container.innerHTML += `<button id="show-pumping-rate-graph" class="graph-toggle-btn px-2 py-1 text-sm rounded-md">揚水量</button>`;
            }

            if (firstActiveType) {
                 document.getElementById(`show-${firstActiveType.replace('_', '-')}-graph`).classList.add('graph-toggle-btn-active');
                 updateDataChart(firstActiveType, measurements);
            } else {
                if (dataChart) dataChart.destroy();
            }

            if (hasWaterLevel) {
                 document.getElementById('show-water-level-graph').addEventListener('click', (e) => toggleGraph(e, 'water_level'));
            }
            if (hasPumpingRate) {
                 document.getElementById('show-pumping-rate-graph').addEventListener('click', (e) => toggleGraph(e, 'pumping_rate'));
            }
        }
        
        function toggleGraph(event, type) {
            document.querySelectorAll('.graph-toggle-btn').forEach(btn => btn.classList.remove('graph-toggle-btn-active'));
            event.target.classList.add('graph-toggle-btn-active');
            updateDataChart(type, allMeasurementsCache);
        }

        // =================================================================================
        // アプリケーションの起動
        // =================================================================================
        window.onload = async () => {
            await initializeFirebase();
            setupWellListListeners();
        };

        function setupWellListListeners() {
             document.getElementById('well-list-container').addEventListener('change', (e) => {
                if(e.target.matches('.well-checkbox')) {
                    const checkedCount = document.querySelectorAll('.well-checkbox:checked').length;
                    document.getElementById('well-list-actions').classList.toggle('hidden', checkedCount === 0);
                }
            });
            document.getElementById('delete-selected-wells-btn').addEventListener('click', handleBulkDelete);
        }

    </script>
    
    <!-- Service Worker and manifest files -->

</body>
</html>
