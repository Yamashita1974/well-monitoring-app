<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水位観測アプリ</title>
    
    <!-- PWAマニフェスト -->
    <link rel="manifest" href="manifest.json">

    <!-- スタイルシート (Tailwind CSS & Leaflet CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    
    <!-- ライブラリ (Leaflet & Chart.js) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        #map { height: 100vh; }
        .slide-in { transform: translateX(0%); transition: transform 0.3s ease-in-out; }
        .slide-out { transform: translateX(100%); transition: transform 0.3s ease-in-out; }
        .modal-hidden { display: none; }
        .custom-marker-icon { background: none; border: none; }
        .leaflet-tooltip-permanent {
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid #ccc;
            border-radius: 4px; padding: 4px 8px;
            white-space: nowrap; font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    
    <!-- プロジェクト選択モーダル -->
    <div id="project-modal" class="modal-hidden fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-[2000]">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">プロジェクト選択</h2>
            <p class="text-gray-600 mb-6">作業するプロジェクトを選択または新規作成してください。</p>
            <div class="mb-4">
                <label for="project-id-input" class="block text-sm font-medium text-gray-700">プロジェクトID</label>
                <input type="text" id="project-id-input" placeholder="例: tokyo-site-2025" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
            <button id="start-project-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 font-bold">開始</button>
            <div class="mt-6">
                <h3 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-3">最近使ったプロジェクト</h3>
                <div id="recent-projects-list" class="space-y-2 max-h-32 overflow-y-auto"></div>
            </div>
        </div>
    </div>
    
    <!-- メインコンテンツエリア -->
    <div id="main-content" class="invisible">
        <div id="map"></div>
        <div id="project-indicator" class="fixed top-4 left-1/2 -translate-x-1/2 bg-white/90 p-2 rounded-lg shadow-lg z-[1001] flex items-center space-x-4">
            <span class="font-semibold">プロジェクト: <span id="current-project-id-display"></span></span>
            <button id="switch-project-btn" class="text-sm text-blue-600 hover:underline">切り替え</button>
        </div>
        <div class="fixed bottom-4 right-4 z-[1001] flex flex-col space-y-2">
            <button id="toggle-labels-btn" class="bg-purple-600 text-white p-4 rounded-full shadow-lg hover:bg-purple-700" title="井戸名表示/非表示"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" /></svg></button>
            <button id="open-import-modal-btn" class="bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700" title="データ取込"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg></button>
            <button id="open-add-well-modal-btn" class="bg-green-600 text-white p-4 rounded-full shadow-lg hover:bg-green-700" title="新規井戸追加"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg></button>
            <button id="open-well-list-modal-btn" class="bg-gray-600 text-white p-4 rounded-full shadow-lg hover:bg-gray-700" title="井戸一覧"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg></button>
        </div>
        <div id="well-details-panel" class="fixed top-0 right-0 h-full md:w-1/3 bg-white shadow-lg z-[1001] p-6 overflow-y-auto slide-out"><!-- サイドパネルの中身はJSで生成 --></div>
        <div id="offline-indicator" class="hidden fixed bottom-4 left-4 bg-yellow-500 text-white text-sm font-bold py-2 px-4 rounded-full z-[1002]"><p>オフラインモード</p></div>
    </div>

    <!-- その他のモーダルHTML -->
    <div id="add-well-modal" class="modal-hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[1003]"><!-- JSで制御 --></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDocs, onSnapshot, collection, writeBatch, enableNetwork, disableNetwork } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const App = {
            // --- 状態管理 ---
            db: null, auth: null, userId: null, currentProjectId: null,
            unsubscribeWells: null, unsubscribeMeasurements: null,
            map: null, wellMarkersLayer: null, wellMarkers: {}, wellDataCache: {},
            currentWell: null, waterLevelChart: null, areLabelsVisible: false,

            // --- 1. 初期化フロー ---
            init() {
                this.bindDOMElements();
                this.initializeFirebase();
            },

            bindDOMElements() {
                this.dom = {
                    projectModal: document.getElementById('project-modal'),
                    startProjectBtn: document.getElementById('start-project-btn'),
                    switchProjectBtn: document.getElementById('switch-project-btn'),
                    mainContent: document.getElementById('main-content'),
                    currentProjectIdDisplay: document.getElementById('current-project-id-display'),
                    recentProjectsList: document.getElementById('recent-projects-list'),
                    projectIdInput: document.getElementById('project-id-input'),
                };
                this.dom.startProjectBtn.addEventListener('click', () => this.handleStartProjectFromClick());
                this.dom.switchProjectBtn.addEventListener('click', () => this.showProjectModal());
            },

            async initializeFirebase() {
                try {
                    const firebaseConfig = {
                        apiKey: "AIzaSyAYovasyBOIls5q9ZVX7_HeJmeeDD9OcpU",
                        authDomain: "idochousa2025.firebaseapp.com",
                        projectId: "idochousa2025",
                        storageBucket: "idochousa2025.appspot.com",
                        messagingSenderId: "55272688318",
                        appId: "1:55272688318:web:c665ace11cda1a9eeb2cef"
                    };
                    const app = initializeApp(firebaseConfig);
                    this.db = getFirestore(app);
                    this.auth = getAuth(app);
                    
                    onAuthStateChanged(this.auth, (user) => {
                        if (user) {
                            this.userId = user.uid;
                            this.setupProjectSelection();
                        }
                    });

                    await signInAnonymously(this.auth);

                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    alert(`Firebase初期化エラー: ${error.message}`);
                }
            },

            setupProjectSelection() {
                const recentProjects = JSON.parse(localStorage.getItem('recentProjects') || '[]');
                this.updateRecentProjectsList(recentProjects);
                
                const lastProjectId = localStorage.getItem('currentProjectId');
                if (lastProjectId && recentProjects.includes(lastProjectId)) {
                    this.startProject(lastProjectId);
                } else {
                    this.showProjectModal();
                }
            },
            
            // --- 2. プロジェクト管理 ---
            handleStartProjectFromClick() {
                const id = this.dom.projectIdInput.value.trim().replace(/[^a-zA-Z0-9-]/g, '');
                if (!id) {
                    alert('プロジェクトIDを入力してください。');
                    return;
                }
                this.startProject(id);
            },

            async startProject(id) {
                if (!id) {
                    console.error("startProject called with an invalid ID.");
                    return;
                }
                
                console.log(`Starting project: ${id}`);
                this.resetAppState();
                this.currentProjectId = id;
                this.saveProjectHistory(id);

                try {
                    await this.loadProjectData();
                    this.initializeAppUI();
                    this.hideProjectModal();
                    console.log(`Project ${id} started successfully.`);
                } catch (error) {
                    console.error("Failed to start project:", error);
                    alert(`プロジェクトの読み込みに失敗しました。\n\nエラー: ${error.message}\n\nFirestoreのセキュリティルールが正しく設定されているか確認してください。`);
                    this.showProjectModal();
                }
            },

            resetAppState() {
                if (this.unsubscribeWells) this.unsubscribeWells();
                if (this.unsubscribeMeasurements) this.unsubscribeMeasurements();
                if (this.wellMarkersLayer) this.wellMarkersLayer.clearLayers();
                this.wellMarkers = {};
                this.wellDataCache = {};
            },

            saveProjectHistory(id) {
                let recent = JSON.parse(localStorage.getItem('recentProjects') || '[]');
                if (!recent.includes(id)) {
                    recent.unshift(id);
                    recent = recent.slice(0, 5);
                    localStorage.setItem('recentProjects', JSON.stringify(recent));
                    this.updateRecentProjectsList(recent);
                }
                localStorage.setItem('currentProjectId', id);
            },

            async loadProjectData() {
                await this.populateSampleData();
                this.listenForWells();
            },

            initializeAppUI() {
                if (!this.map) this.initMap();
                this.dom.currentProjectIdDisplay.textContent = this.currentProjectId;
                this.dom.mainContent.classList.remove('invisible');
            },

            showProjectModal() {
                this.dom.projectModal.classList.remove('modal-hidden');
                this.dom.mainContent.classList.add('invisible');
            },

            hideProjectModal() {
                this.dom.projectModal.classList.add('modal-hidden');
            },
            
            updateRecentProjectsList(projects) {
                this.dom.recentProjectsList.innerHTML = '';
                if (projects.length === 0) {
                    this.dom.recentProjectsList.innerHTML = '<p class="text-gray-500 text-sm">履歴はありません。</p>';
                    return;
                }
                projects.forEach(id => {
                    const item = document.createElement('button');
                    item.className = 'w-full text-left p-2 bg-gray-100 hover:bg-gray-200 rounded-md';
                    item.textContent = id;
                    item.onclick = () => this.startProject(id);
                    this.dom.recentProjectsList.appendChild(item);
                });
            },

            // --- 3. Firestore & データ操作 ---
            getCollections() {
                if (!this.currentProjectId) throw new Error("No project selected");
                return {
                    wells: collection(this.db, 'projects', this.currentProjectId, 'wells'),
                    measurements: collection(this.db, 'projects', this.currentProjectId, 'measurements'),
                };
            },

            async populateSampleData() {
                const { wells } = this.getCollections();
                const snapshot = await getDocs(wells);
                if (snapshot.empty) {
                    console.log(`Populating sample data for project: ${this.currentProjectId}`);
                    const batch = writeBatch(this.db);
                    const sampleWells = [
                        { id: 'well-001', name: 'A-1観測井', lat: 35.681, lng: 139.767, color: '#3b82f6' },
                        { id: 'well-002', name: 'B-3調査井', lat: 35.443, lng: 139.638, color: '#ef4444' },
                    ];
                    sampleWells.forEach(w => {
                        const { id, ...data } = w;
                        batch.set(doc(wells, id), data);
                    });
                    await batch.commit();
                }
            },

            listenForWells() {
                if (this.unsubscribeWells) this.unsubscribeWells();
                const { wells } = this.getCollections();
                this.unsubscribeWells = onSnapshot(wells, (snapshot) => {
                    const wellList = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    this.wellDataCache = wellList.reduce((acc, well) => ({ ...acc, [well.id]: well }), {});
                    this.updateMapMarkers(wellList);
                }, (error) => {
                    console.error("Error listening for wells:", error);
                    alert(`データ同期エラー: ${error.message}`);
                });
            },

            // --- 4. 地図 & マーカー ---
            initMap() {
                if (this.map) return;
                this.map = L.map('map').setView([35.681, 139.767], 10);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap'
                }).addTo(this.map);
                this.wellMarkersLayer = L.featureGroup().addTo(this.map);
            },
            
            createColorIcon(color = '#3b82f6') {
                const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="30" height="30"><path fill="${color}" stroke="#fff" stroke-width="1.5" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/><circle cx="12" cy="9" r="2.5" fill="#fff"/></svg>`;
                return L.divIcon({ html: svg, className: 'custom-marker-icon', iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -30] });
            },

            updateMapMarkers(wells) {
                if (!this.wellMarkersLayer) return;
                this.wellMarkersLayer.clearLayers();
                this.wellMarkers = {};
                wells.forEach(well => {
                    if (well.lat != null && well.lng != null) {
                        const marker = L.marker([well.lat, well.lng], { icon: this.createColorIcon(well.color) });
                        // TODO: Add full popup and panel functionality
                        marker.bindPopup(`<b>${well.name}</b>`);
                        this.wellMarkersLayer.addLayer(marker);
                        this.wellMarkers[well.id] = marker;
                    }
                });
                if (wells.length > 0) {
                    this.map.fitBounds(this.wellMarkersLayer.getBounds(), { padding: [50, 50] });
                }
            },
        };

        // --- アプリケーションの実行開始 ---
        document.addEventListener('DOMContentLoaded', () => App.init());

    </script>
</body>
</html>