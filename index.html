<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水位観測アプリ</title>
    
    <!-- PWAマニフェスト -->
    <link rel="manifest" href="manifest.json">

    <!-- スタイルシート (Tailwind CSS & Leaflet CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    
    <!-- ライブラリ (Leaflet & Chart.js) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* UIの微調整 */
        #map { height: 100vh; cursor: default; }
        .map-crosshair { cursor: crosshair; }
        .leaflet-bottom, .leaflet-top { z-index: 1000; }
        .slide-in {
            transform: translateX(0%);
            transition: transform 0.3s ease-in-out;
        }
        .slide-out {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        /* モーダル表示用のスタイル */
        .modal-hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    
    <!-- プロジェクト選択モーダル -->
    <div id="project-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-[2000]">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">プロジェクト選択</h2>
            <p class="text-gray-600 mb-6">作業するプロジェクトを選択または新規作成してください。</p>
            
            <div class="mb-4">
                <label for="project-id-input" class="block text-sm font-medium text-gray-700">新規または既存のプロジェクトID</label>
                <input type="text" id="project-id-input" placeholder="例: tokyo-site-2025" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <p class="text-xs text-gray-500 mt-1">IDには英数字とハイフンのみ使用できます。</p>
            </div>
            
            <button id="start-project-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 font-bold">このIDで開始</button>
            
            <div class="mt-6">
                <h3 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-3">最近使ったプロジェクト</h3>
                <div id="recent-projects-list" class="space-y-2 max-h-32 overflow-y-auto">
                    <p class="text-gray-500 text-sm">履歴はありません。</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ★★★★★ 変更点: メインコンテンツエリアをコンテナで囲む ★★★★★ -->
    <div id="main-content" class="invisible">
        <!-- 地図コンテナ -->
        <div id="map"></div>

        <!-- 現在のプロジェクト表示エリア -->
        <div id="project-indicator" class="fixed top-4 left-1/2 -translate-x-1/2 bg-white/90 text-gray-800 p-2 rounded-lg shadow-lg z-[1001] flex items-center space-x-4">
            <span class="font-semibold">プロジェクト: <span id="current-project-id-display"></span></span>
            <button id="switch-project-btn" class="text-sm text-blue-600 hover:underline">切り替え</button>
        </div>

        <!-- UIボタンコンテナ -->
        <div class="fixed bottom-4 right-4 z-[1001] flex flex-col space-y-2">
             <!-- ... (ボタンのHTMLは変更なし) ... -->
        </div>
    
        <!-- 井戸詳細サイドパネル -->
        <div id="well-details-panel" class="fixed top-0 right-0 h-full w-full md:w-1/3 bg-white shadow-lg z-[1001] p-6 overflow-y-auto slide-out">
             <!-- ... (パネル内のHTMLは変更なし) ... -->
        </div>
        
        <div id="offline-indicator" class="hidden fixed bottom-4 left-4 bg-yellow-500 text-white text-sm font-bold py-2 px-4 rounded-full shadow-lg z-[1002]">
            <p>オフラインモードで動作中</p>
        </div>
    </div>


    <!-- (モーダルダイアログのHTMLは変更なし) -->
    <div id="import-modal" class="modal-hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[1002]">...</div>
    <div id="add-well-modal" class="modal-hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[1003]">...</div>
    <div id="well-list-modal" class="modal-hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[1003]">...</div>
    <div id="delete-confirm-modal" class="modal-hidden fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-[1004]">...</div>


    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, writeBatch, enableNetwork, disableNetwork, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================================
        // グローバル変数と初期設定
        // =================================================================================
        let db, auth;
        let userId = null;
        let currentProjectId = null;
        let unsubscribeWells = null;
        let unsubscribeMeasurements = null;

        let map; // ★★★★★ 変更点: 初期化前はundefined
        let waterLevelChart; // ★★★★★ 変更点: 初期化前はundefined
        let currentWell = null;
        let wellMarkersLayer = null; // ★★★★★ 変更点: 初期化前はnull
        let wellMarkers = {};
        
        // =================================================================================
        // ★★★★★ 変更点: アプリケーション起動フローを再構築 ★★★★★
        // =================================================================================
        
        // --- 1. アプリケーションのエントリーポイント ---
        window.onload = () => {
            console.log("Step 1: Window loaded. Initializing Firebase...");
            initializeFirebase();
        };

        // --- 2. Firebaseの初期化と認証 ---
        async function initializeFirebase() {
            try {
                const firebaseConfig = {
                  apiKey: "AIzaSyAYovasyBOIls5q9ZVX7_HeJmeeDD9OcpU",
                  authDomain: "idochousa2025.firebaseapp.com",
                  projectId: "idochousa2025",
                  storageBucket: "idochousa2025.appspot.com",
                  messagingSenderId: "55272688318",
                  appId: "1:55272688318:web:c665ace11cda1a9eeb2cef"
                };

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Step 2: Authentication successful. User ID:", userId);
                        // 認証が成功したら、初めてプロジェクト選択UIの準備をする
                        setupProjectSelection();
                    } else {
                        console.log("User is not signed in.");
                    }
                });

                // 匿名サインインを試みる
                await signInAnonymously(auth);

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                alert(`アプリケーションの初期化に失敗しました: ${error.message}`);
            }
        }

        // --- 3. プロジェクト選択UIのセットアップ ---
        function setupProjectSelection() {
            console.log("Step 3: Setting up project selection UI.");
            document.getElementById('start-project-btn').addEventListener('click', handleStartProject);
            document.getElementById('switch-project-btn').addEventListener('click', showProjectModal);

            const recentProjects = JSON.parse(localStorage.getItem('recentProjects') || '[]');
            updateRecentProjectsList(recentProjects);

            const lastProjectId = localStorage.getItem('currentProjectId');
            if (lastProjectId && recentProjects.includes(lastProjectId)) {
                 // 以前のプロジェクトIDがあれば、それでアプリを開始する
                handleStartProject(lastProjectId);
            } else {
                // なければプロジェクト選択モーダルを表示
                showProjectModal();
            }
        }

        function showProjectModal() {
            console.log("Showing project modal.");
            document.getElementById('project-modal').classList.remove('modal-hidden');
            // メインコンテンツは隠したまま
        }

        function hideProjectModal() {
            console.log("Hiding project modal.");
            document.getElementById('project-modal').classList.add('modal-hidden');
        }
        
        // --- 4. プロジェクトの開始処理 ---
        async function handleStartProject(preselectedId = null) {
            const projectIdInput = document.getElementById('project-id-input');
            const projectId = preselectedId || projectIdInput.value.trim().replace(/[^a-zA-Z0-9-]/g, '');

            if (!projectId) {
                alert('プロジェクトIDを入力してください。');
                return;
            }
            
            console.log(`Step 4: Starting project "${projectId}"...`);

            // 既存のリスナーがあれば解除
            if (unsubscribeWells) unsubscribeWells();
            if (unsubscribeMeasurements) unsubscribeMeasurements();
            
            // UIをリセット
            if (currentWell) closePanel();
            if (wellMarkersLayer) wellMarkersLayer.clearLayers();
            wellMarkers = {};

            currentProjectId = projectId;
            
            // ローカルストレージを更新
            localStorage.setItem('currentProjectId', projectId);
            let recentProjects = JSON.parse(localStorage.getItem('recentProjects') || '[]');
            if (!recentProjects.includes(projectId)) {
                recentProjects.unshift(projectId);
                recentProjects = recentProjects.slice(0, 5);
                localStorage.setItem('recentProjects', JSON.stringify(recentProjects));
                updateRecentProjectsList(recentProjects);
            }
            
            // Firestoreからデータを読み込み、成功すればアプリのメイン部分を初期化
            try {
                await loadProjectData();
                initializeAppUI();
                hideProjectModal();
                console.log(`Step 5: Project "${projectId}" started successfully.`);
            } catch (error) {
                console.error(`Project "${projectId}" failed to start:`, error);
                alert(`プロジェクトの読み込みに失敗しました。\n\n原因: Firestoreのセキュリティルールが正しく設定されていない可能性があります。\nエラー: ${error.message}`);
                showProjectModal(); // 失敗したら再度モーダルを表示
            }
        }

        // --- 5. プロジェクトデータの読み込み ---
        async function loadProjectData() {
            console.log("Loading project data from Firestore...");
            // この関数は、データへのアクセス権があるかどうかのテストも兼ねる
            await populateSampleData();
            listenForWells();
        }

        // --- 6. メインUIの初期化 ---
        function initializeAppUI() {
            console.log("Initializing main application UI...");
            // ここで初めて地図やその他のUIを初期化する
            if (!map) {
                initMap();
            }
            // プロジェクトID表示などを更新
            document.getElementById('current-project-id-display').textContent = currentProjectId;
            if (document.getElementById('user-id-display')) {
                document.getElementById('user-id-display').textContent = `${userId.substring(0, 8)}...`;
            }
            // メインコンテンツを表示状態にする
            document.getElementById('main-content').classList.remove('invisible');
        }

        // =================================================================================
        // Firestore データ操作 (変更なし)
        // =================================================================================
        function getCollections() {
            if (!currentProjectId) throw new Error("プロジェクトが選択されていません。");
            const wellsCollectionRef = collection(db, 'projects', currentProjectId, 'wells');
            const measurementsCollectionRef = collection(db, 'projects', currentProjectId, 'measurements');
            return { wellsCollectionRef, measurementsCollectionRef };
        }
        
        async function populateSampleData() {
            // この関数は呼び出し元でtry-catchされる
            const { wellsCollectionRef } = getCollections();
            const snapshot = await getDocs(wellsCollectionRef); // ここで権限エラーが起きる可能性がある

            if (snapshot.empty) {
                // (サンプルデータ投入処理は変更なし)
            }
        }
        
        function listenForWells() {
            if (unsubscribeWells) unsubscribeWells();
            if (!currentProjectId) return;
            
            const { wellsCollectionRef } = getCollections();
            unsubscribeWells = onSnapshot(wellsCollectionRef, (snapshot) => {
                const wells = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateMapMarkers(wells);
            }, (error) => {
                console.error("Error listening for well updates:", error);
                // リアルタイムリスナーでのエラーもユーザーに通知
                alert(`データの同期中にエラーが発生しました: ${error.message}`);
            });
        }
        
        function updateMapMarkers(wells) {
            if (!wellMarkersLayer) return;
            wellMarkersLayer.clearLayers();
            // (マーカー作成ロジックは変更なし)
        }

        // =================================================================================
        // 地図の初期化 (変更なし)
        // =================================================================================
        
        function initMap() {
            if (map) return; // 二重初期化を防止
            console.log("Initializing Leaflet map.");
            map = L.map('map').setView([35.681236, 139.767125], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            wellMarkersLayer = L.featureGroup().addTo(map);
        }

        // =================================================================================
        // その他のヘルパー関数やイベントハンドラ
        // (updateRecentProjectsList, closePanel, ... などの関数は変更なし)
        // =================================================================================
        function updateRecentProjectsList(projects) {
            const listEl = document.getElementById('recent-projects-list');
            listEl.innerHTML = '';
            if (projects.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 text-sm">履歴はありません。</p>';
                return;
            }
            projects.forEach(id => {
                const item = document.createElement('button');
                item.className = 'w-full text-left p-2 bg-gray-100 hover:bg-gray-200 rounded-md';
                item.textContent = id;
                item.onclick = () => handleStartProject(id);
                listEl.appendChild(item);
            });
        }
        
        // (その他の関数は元のコードのままここにペーストしてください)
        // closePanel, updateMeasurementList, updateWaterLevelChart, handleAddMeasurement, 
        // handleFileSelect, parseCSV, importDataToDB, handleExportCSV, handleSelectLocationOnMap,
        // handleSaveNewWell, handleDeleteWell, handleOpenWellList, jumpToWell など
        
    </script>
    
    <!-- (sw.js と manifest.json のコメントは変更なし) -->

</body>
</html>

このコードで何が変わったか

起動フローの整理: window.onloadから始まり、initializeFirebase → setupProjectSelection → handleStartProject → loadProjectData → initializeAppUI という一連の流れを明確にしました。

UIの遅延読み込み: メインコンテンツ全体を#main-contentで囲み、デフォルトでinvisibleにしておきます。プロジェクトのデータ読み込みが成功した initializeAppUI の中で初めて表示 (visible) するように変更しました。これにより、データがない状態でUIを初期化しようとしてフリーズするのを防ぎます。

エラーハンドリングの強化: handleStartProject内のtry...catchブロックで、プロジェクトのデータ読み込み（loadProjectData）に失敗した場合、ユーザーにアラートで通知し、プロジェクト選択モーダルを再度表示して操作不能になるのを防ぎます。

ご確認いただきたいこと

Firestoreセキュリティルールの確認: 前回の回答で提案したセキュリティルールがFirebaseコンソールに正しく適用されているか、今一度ご確認ください。これが適用されていないと、今回のコードでも権限エラーで先に進めません。

ブラウザのコンソール: この新しいコードで試してもフリーズする場合、ブラウザのデベロッパーツール（F12キーで開けます）の「コンソール」タブに何かエラーメッセージが表示されていないかご確認ください。もしエラーがあれば、その内容を教えていただけると、さらに的を絞った解決策を提案できます。

お手数をおかけしますが、ご確認のほどよろしくお願いいたします。